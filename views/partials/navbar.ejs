<nav class="navbar">
    <a href="/" class="logo">
        <i class="fas fa-snowflake"></i> ДАЧА ЗЕЙНА
    </a>

    <div class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <div class="nav-menu" id="navMenu">
        
        <div class="nav-links">
            <a href="/wrapped" class="nav-item nav-wrapped">
                <i class="fas fa-star"></i> ИТОГИ 2025
            </a>

            <a href="/market" class="nav-item"><i class="fas fa-chart-line"></i> Биржа</a>
            <a href="/shop" class="nav-item"><i class="fas fa-store"></i> Магазин</a>
            
            <a href="/giveaways" class="nav-item highlight-gold"><i class="fas fa-gift"></i> Халява</a>
            
            <a href="/wiki" class="nav-item"><i class="fas fa-book"></i> Вики</a>
            
            <a href="/leaderboard" class="nav-item desktop-hide-sm"><i class="fas fa-trophy"></i> Топ</a>
        </div>

        <div class="auth">
            <% if (typeof user !== 'undefined' && user) { %>
                
                <% if (typeof profile !== 'undefined' && profile) { %>
                    <div class="nav-balance-group">
                        <div class="nav-balance stars" title="Звезды">
                            <span class="nb-icon">⭐</span>
                            <span class="nb-val"><%= Math.floor(profile.stars).toLocaleString() %></span>
                        </div>
                        <div class="nav-balance shards" title="Осколки">
                            <span class="nb-icon">✨</span>
                            <span class="nb-val"><%= Math.floor(profile.shards).toLocaleString() %></span>
                        </div>
                    </div>
                <% } %>

                <div class="profile-dropdown-wrapper">
                    <div class="profile-trigger" onclick="toggleDropdown()">
                        <% if (user.avatar) { %>
                            <img src="/img/proxy/avatar/<%= user.id %>/<%= user.avatar %>" alt="Ava">
                        <% } else { %>
                            <img src="/assets/img/avatars/default_avatar.png" alt="Ava">
                        <% } %>
                        <span class="trigger-name"><%= user.username %></span>
                        <i class="fas fa-chevron-down trigger-arrow"></i>
                    </div>

                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header">
                            <span class="role-badge">Игрок</span>
                        </div>
                        
                        <div class="dropdown-grid">
                            <a href="/profile/<%= user.id %>" class="dd-item"><i class="fas fa-user-circle"></i> Профиль</a>
                            <a href="/inventory" class="dd-item"><i class="fas fa-briefcase"></i> Инвентарь</a>
                            <a href="/deposit" class="dd-item"><i class="fas fa-university"></i> Банк</a>
                            <a href="/daily" class="dd-item"><i class="fas fa-calendar-check"></i> Дейли</a>
                        </div>

                        <div class="dropdown-footer">
                            <a href="/auth/logout" class="dd-logout" onclick="confirmLogout(event)">
                                <i class="fas fa-sign-out-alt"></i> Выйти
                            </a>
                        </div>
                    </div>
                </div>

            <% } else { %>
                <a href="/auth/discord" class="btn-discord">
                    <i class="fab fa-discord"></i> Войти
                </a>
            <% } %>
        </div>
    </div>
</nav>

<div id="navOverlay" onclick="closeAllMenus()"></div>

<script nonce="<%= nonce %>">
    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. ДИНАМИЧЕСКАЯ ЗАГРУЗКА SOCKET.IO (Чтобы не тормозить LCP)
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        script.nonce = '<%= nonce %>';
        script.async = true; // Важно: асинхронная загрузка

        script.onload = () => {
            // Код запускается только когда библиотека загружена
            try {
                const socket = io();
                
                // Слушаем личные обновления (баланс, инвентарь)
                socket.on('user_update', (data) => {
                    // console.log('⚡ User Update:', data);
                    
                    // 1. ОБНОВЛЕНИЕ ЗВЕЗД
                    if (typeof data.stars !== 'undefined') {
                        const starsElements = document.querySelectorAll('.nav-balance.stars .nb-val, #userBalanceDisplay');
                        
                        starsElements.forEach(el => {
                            const isNavbar = el.classList.contains('nb-val');
                            if (isNavbar) {
                                el.innerText = Math.floor(data.stars).toLocaleString();
                            } else {
                                el.innerText = Math.floor(data.stars).toLocaleString() + ' ⭐';
                            }
                            
                            el.style.transition = 'color 0.3s';
                            el.style.color = '#2ecc71';
                            setTimeout(() => el.style.color = '', 500);
                        });
                    }

                    // 2. ОБНОВЛЕНИЕ ОСКОЛКОВ
                    if (typeof data.shards !== 'undefined') {
                        document.querySelectorAll('.nav-balance.shards .nb-val').forEach(el => {
                            el.innerText = Math.floor(data.shards).toLocaleString();
                            
                            el.style.transition = 'color 0.3s';
                            el.style.color = '#e67e22';
                            setTimeout(() => el.style.color = '', 500);
                        });
                    }
                });
            } catch (e) {
                console.warn('Socket.io failed to init:', e);
            }
        };

        // Добавляем скрипт в конец body, запуская загрузку
        document.body.appendChild(script);
    });

    // --- Логика меню (глобальные функции) ---
    function toggleMobileMenu() {
        const menu = document.getElementById('navMenu');
        const btn = document.querySelector('.mobile-menu-btn');
        const overlay = document.getElementById('navOverlay');
        
        menu.classList.toggle('active');
        btn.classList.toggle('open');
        overlay.classList.toggle('active');
        document.getElementById('profileDropdown')?.classList.remove('active');
    }

    function toggleDropdown() {
        const dd = document.getElementById('profileDropdown');
        const arrow = document.querySelector('.trigger-arrow');
        const overlay = document.getElementById('navOverlay');
        
        dd.classList.toggle('active');
        arrow.classList.toggle('rotate');
        overlay.classList.toggle('active-desktop');
    }

    function closeAllMenus() {
        const menu = document.getElementById('navMenu');
        const btn = document.querySelector('.mobile-menu-btn');
        const dd = document.getElementById('profileDropdown');
        const arrow = document.querySelector('.trigger-arrow');
        const overlay = document.getElementById('navOverlay');

        menu.classList.remove('active');
        btn.classList.remove('open');
        if(dd) dd.classList.remove('active');
        if(arrow) arrow.classList.remove('rotate');
        overlay.classList.remove('active');
        overlay.classList.remove('active-desktop');
    }

    window.addEventListener('scroll', () => {
        const navbar = document.querySelector('.navbar');
        if (window.scrollY > 50) navbar.classList.add('scrolled');
        else navbar.classList.remove('scrolled');
    });

    async function confirmLogout(event) {
        event.preventDefault();
        if (typeof Modal !== 'undefined') {
            const confirmed = await Modal.confirm(
                "Выход из аккаунта", 
                "Вы уверены, что хотите выйти?", 
                "warning"
            );
            if (confirmed) window.location.href = '/auth/logout';
        } else {
            if (confirm("Выйти?")) window.location.href = '/auth/logout';
        }
    }
</script>