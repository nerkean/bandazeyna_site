<nav class="navbar">
    <a href="/" class="logo">
        <i class="fas fa-snowflake"></i> ДАЧА ЗЕЙНА
    </a>

    <div class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <div class="nav-menu" id="navMenu">
        
        <div class="nav-links">
            <a href="/wrapped" class="nav-item nav-wrapped">
                <i class="fas fa-star"></i> ИТОГИ 2025
            </a>

            <a href="/ideas" class="nav-item nav-ideas">
        <i class="fas fa-lightbulb"></i> Идеи
    </a>

            <a href="/market" class="nav-item"><i class="fas fa-chart-line"></i> Биржа</a>
            <a href="/shop" class="nav-item"><i class="fas fa-store"></i> Магазин</a>
            
            <a href="/giveaways" class="nav-item highlight-gold"><i class="fas fa-gift"></i> Халява</a>
            
            <a href="/wiki" class="nav-item"><i class="fas fa-book"></i> Вики</a>
            
            <a href="/leaderboard" class="nav-item desktop-hide-sm"><i class="fas fa-trophy"></i> Топ</a>
        </div>

        <div class="auth">
            <% if (typeof user !== 'undefined' && user) { %>
                
                <% if (typeof profile !== 'undefined' && profile) { %>
                    <div class="nav-balance-group">
                        <div class="nav-balance stars" title="Звезды">
                            <span class="nb-icon">⭐</span>
                            <span class="nb-val"><%= Math.floor(profile.stars).toLocaleString() %></span>
                        </div>
                        <div class="nav-balance shards" title="Осколки">
                            <span class="nb-icon">✨</span>
                            <span class="nb-val"><%= Math.floor(profile.shards).toLocaleString() %></span>
                        </div>
                    </div>
                <% } %>

                <div class="profile-dropdown-wrapper">
                    <div class="profile-trigger" id="profileTrigger">
                        <% if (user.avatar) { %>
                            <img src="/img/proxy/avatar/<%= user.id %>/<%= user.avatar %>" alt="Ava">
                        <% } else { %>
                            <img src="/assets/img/avatars/default_avatar.png" alt="Ava">
                        <% } %>
                        <span class="trigger-name"><%= user.username %></span>
                        <i class="fas fa-chevron-down trigger-arrow"></i>
                    </div>

                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header">
                            <span class="role-badge">Игрок</span>
                        </div>
                        
                        <div class="dropdown-grid">
                            <a href="/profile/<%= user.id %>" class="dd-item"><i class="fas fa-user-circle"></i> Профиль</a>
                            <a href="/inventory" class="dd-item"><i class="fas fa-briefcase"></i> Инвентарь</a>
                            <a href="/deposit" class="dd-item"><i class="fas fa-university"></i> Банк</a>
                            <a href="/daily" class="dd-item"><i class="fas fa-calendar-check"></i> Дейли</a>
                        </div>

                        <div class="dropdown-footer">
                            <a href="/auth/logout" class="dd-logout" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Выйти
                            </a>
                        </div>
                    </div>
                </div>

            <% } else { %>
                <a href="/auth/discord" class="btn-discord">
                    <i class="fab fa-discord"></i> Войти
                </a>
            <% } %>
        </div>
    </div>
</nav>

<div id="navOverlay"></div>

<script nonce="<%= nonce %>">
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- 1. ЛОГИКА ИНТЕРФЕЙСА (МЕНЮ, ПРОФИЛЬ, СКРОЛЛ) ---
        
        const mobileBtn = document.getElementById('mobileMenuBtn');
        const navMenu = document.getElementById('navMenu');
        const overlay = document.getElementById('navOverlay');
        
        const profileTrigger = document.getElementById('profileTrigger');
        const profileDropdown = document.getElementById('profileDropdown');
        const triggerArrow = document.querySelector('.trigger-arrow');
        
        const logoutBtn = document.getElementById('logoutBtn');
        const navbar = document.querySelector('.navbar');

        // Функция закрытия всего
        const closeAll = () => {
            if(navMenu) navMenu.classList.remove('active');
            if(mobileBtn) mobileBtn.classList.remove('open');
            if(profileDropdown) profileDropdown.classList.remove('active');
            if(triggerArrow) triggerArrow.classList.remove('rotate');
            if(overlay) {
                overlay.classList.remove('active');
                overlay.classList.remove('active-desktop');
            }
        };

        // Мобильное меню
        if (mobileBtn && navMenu && overlay) {
            mobileBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Чтобы клик не ушел на body
                navMenu.classList.toggle('active');
                mobileBtn.classList.toggle('open');
                overlay.classList.toggle('active');
                // Если открываем мобильное меню, закрываем дропдаун профиля
                if(profileDropdown) profileDropdown.classList.remove('active');
            });
        }

        // Дропдаун профиля
        if (profileTrigger && profileDropdown) {
            profileTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('active');
                if(triggerArrow) triggerArrow.classList.toggle('rotate');
                if(overlay) overlay.classList.toggle('active-desktop');
            });
        }

        // Клик по оверлею (затемнению) закрывает всё
        if (overlay) {
            overlay.addEventListener('click', closeAll);
        }

        // Скролл навбара
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) navbar.classList.add('scrolled');
            else navbar.classList.remove('scrolled');
        });

        // Подтверждение выхода
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                let confirmed = false;
                
                if (typeof Modal !== 'undefined') {
                    confirmed = await Modal.confirm("Выход", "Точно выйти?", "warning");
                } else {
                    confirmed = confirm("Выйти?");
                }

                if (confirmed) window.location.href = '/auth/logout';
            });
        }


        // --- 2. SOCKET.IO (ЖИВОЙ БАЛАНС) ---
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        script.nonce = '<%= nonce %>';
        script.async = true;

        script.onload = () => {
            try {
                const socket = io();
                socket.on('user_update', (data) => {
                    // Обновление Звезд
                    if (typeof data.stars !== 'undefined') {
                        const starsElements = document.querySelectorAll('.nav-balance.stars .nb-val, #userBalanceDisplay');
                        starsElements.forEach(el => {
                            const isNavbar = el.classList.contains('nb-val');
                            el.innerText = Math.floor(data.stars).toLocaleString() + (isNavbar ? '' : ' ⭐');
                            el.style.color = '#2ecc71';
                            setTimeout(() => el.style.color = '', 500);
                        });
                    }
                    // Обновление Осколков
                    if (typeof data.shards !== 'undefined') {
                        document.querySelectorAll('.nav-balance.shards .nb-val').forEach(el => {
                            el.innerText = Math.floor(data.shards).toLocaleString();
                            el.style.color = '#e67e22';
                            setTimeout(() => el.style.color = '', 500);
                        });
                    }
                });
            } catch (e) { console.warn('Socket init error:', e); }
        };
        document.body.appendChild(script);
    });
</script>