<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: 'Wiki Admin | List' }) %>
    <style>
        .admin-wrap { max-width: 1000px; margin: 120px auto; padding: 0 20px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        
        .art-list { display: flex; flex-direction: column; gap: 10px; }
        .art-row {
            background: #16181e; padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s;
        }
        .art-row:hover { border-color: #5865F2; transform: translateX(5px); }
        
        .art-info { display: flex; align-items: center; gap: 15px; }
        .art-icon { width: 40px; height: 40px; background: rgba(88, 101, 242, 0.1); color: #5865F2; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .art-title { font-weight: 700; color: #fff; font-size: 1.1rem; }
        .art-meta { color: #666; font-size: 0.8rem; }
        
        .art-actions { display: flex; gap: 10px; }
        .btn-sm { padding: 8px 15px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; border: none; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
        .btn-edit { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-edit:hover { background: #fff; color: #000; }
        .btn-del { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .btn-del:hover { background: #e74c3c; color: #fff; }
        
        .badge-cat { font-size: 0.7rem; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); color: #aaa; margin-left: 10px; }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="admin-wrap">
        <div class="admin-header">
            <h1>Wiki Менеджер</h1>
            <a href="/admin/wiki/new" class="btn-primary"><i class="fas fa-plus"></i> Создать статью</a>
        </div>

        <div class="art-list">
            <% if (articles.length === 0) { %>
                <p style="text-align:center; color:#666;">Статей пока нет.</p>
            <% } %>

            <% articles.forEach(art => { %>
                <div class="art-row" id="row-<%= art._id %>">
                    <div class="art-info">
                        <div class="art-icon"><i class="<%= art.icon %>"></i></div>
                        <div>
                            <div class="art-title">
                                <%= art.title %>
                                <span class="badge-cat"><%= art.category %></span>
                                <% if (!art.isPublished) { %><span style="color:#e74c3c; margin-left:5px;">(Скрыто)</span><% } %>
                            </div>
                            <div class="art-meta">/wiki/<%= art.slug %> • <%= art.views %> просмотров</div>
                        </div>
                    </div>
                    <div class="art-actions">
                        <a href="/wiki/<%= art.slug %>" target="_blank" class="btn-sm btn-edit"><i class="fas fa-eye"></i></a>
                        <a href="/admin/wiki/edit/<%= art._id %>" class="btn-sm btn-edit"><i class="fas fa-pen"></i></a>
                        <button onclick="deleteArticle('<%= art._id %>')" class="btn-sm btn-del"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script nonce="<%= nonce %>">
        async function deleteArticle(id) {
            if(!confirm('Удалить статью? Это действие нельзя отменить.')) return;
            
            try {
                const res = await fetch('/api/admin/wiki/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                if (res.ok) {
                    document.getElementById('row-' + id).remove();
                } else {
                    alert('Ошибка удаления');
                }
            } catch(e) { alert('Ошибка сети'); }
        }
    </script>
</body>
</html>