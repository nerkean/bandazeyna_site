<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å | –î–∞—á–∞ –ó–µ–π–Ω–∞' }) %>
    
    <style>
        /* public/css/inventory.css - INLINED VERSION */

        /* --- 1. LAYOUT --- */
        .inv-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 20px 80px;
            min-height: 90vh;
        }

        /* --- 2. HEADER --- */
        .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 20px;
        }

        .inv-title h1 {
            font-size: 2.5rem; margin: 0; color: #fff; font-weight: 900;
            letter-spacing: -0.5px;
            text-shadow: 0 0 30px rgba(255,255,255,0.1);
        }
        .inv-count { font-size: 0.9rem; color: #9ca3af; font-family: 'JetBrains Mono', monospace; margin-left: 10px; }

        /* Tabs */
        .inv-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .tab-btn {
            background: #15171e; border: 1px solid rgba(255,255,255,0.1);
            color: #9ca3af; padding: 10px 20px; border-radius: 12px;
            font-weight: 700; font-family: 'Montserrat', sans-serif;
            cursor: pointer; transition: 0.3s; font-size: 0.85rem;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tab-btn.active { background: #5865F2; color: #fff; border-color: #5865F2; box-shadow: 0 4px 15px rgba(88, 101, 242, 0.3); }

        /* Stats */
        .inv-stats { display: flex; align-items: center; gap: 15px; }
        .inv-stat { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 10px; color: #ccc; font-size: 0.9rem; }
        .inv-stat strong { color: #fff; margin-left: 5px; font-family: 'JetBrains Mono'; }

        .btn-secondary {
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: #fff; padding: 10px 25px; border-radius: 12px; text-decoration: none;
            font-weight: 700; transition: 0.3s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn-secondary:hover { background: #fff; color: #000; }


        /* --- 3. INVENTORY GRID (4 CARDS ROW) --- */
        .inv-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* –†–æ–≤–Ω–æ 4 –∫–æ–ª–æ–Ω–∫–∏ */
            gap: 20px;
        }

        /* --- CARD DESIGN (HIGH END) --- */
        .inv-card {
            position: relative;
            background: #16181e; /* –ß—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ —Ñ–æ–Ω–∞ */
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            padding: 20px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center;
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            min-height: 240px; /* –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –≤—Å–µ–≥–æ */
        }

        /* Rarity Styles (Border Bottom + Glow) */
        .inv-card.common { border-bottom: 4px solid #95a5a6; }
        .inv-card.rare { border-bottom: 4px solid #3498db; }
        .inv-card.epic { border-bottom: 4px solid #9b59b6; }
        .inv-card.legendary { 
            border-bottom: 4px solid #ffd700; 
            background: linear-gradient(to bottom, #16181e, rgba(255, 215, 0, 0.08)); 
            border-color: rgba(255, 215, 0, 0.2);
        }

        .inv-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            background: #1b1e25;
        }

        .inv-card.legendary:hover {
            box-shadow: 0 15px 50px rgba(255, 215, 0, 0.15);
        }

        /* Icon Wrapper */
        .inv-visual {
            height: 120px;
            width: 100%;
            display: flex; 
            justify-content: center; 
            align-items: center;
            margin-bottom: 15px;
            position: relative;
            /* –õ–µ–≥–∫–∏–π –∫—Ä—É–≥ –Ω–∞ —Ñ–æ–Ω–µ */
            background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%);
            border-radius: 50%;
        }

        .inv-img { 
            max-width: 90%; max-height: 90%; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .inv-emoji { font-size: 4.5rem; transition: 0.4s; }

        .inv-card:hover .inv-img { transform: scale(1.15) rotate(-5deg); }
        .inv-card:hover .inv-emoji { transform: scale(1.2); }

        /* Quantity Badge */
        .inv-badge {
            position: absolute;
            top: 12px; right: 12px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff; font-size: 0.8rem; font-weight: 800;
            padding: 4px 10px; border-radius: 8px;
            font-family: 'JetBrains Mono';
            backdrop-filter: blur(4px);
        }

        /* Info Text */
        .inv-info {
            width: 100%;
            margin-top: auto; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ –Ω–∏–∑—É */
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .inv-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700; 
            color: #fff; 
            font-size: 1rem;
            line-height: 1.3;
        }

        .inv-type {
            font-size: 0.7rem; 
            color: #9ca3af; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            font-weight: 600;
            background: rgba(255,255,255,0.05);
            padding: 4px 8px;
            border-radius: 6px;
            align-self: center;
        }

        /* Empty State */
        .empty-inv {
            grid-column: 1 / -1; text-align: center; padding: 80px 0;
            background: rgba(255,255,255,0.02); border-radius: 24px;
            border: 2px dashed rgba(255,255,255,0.05);
        }
        .empty-icon { font-size: 4rem; color: #333; margin-bottom: 15px; }
        .empty-inv h3 { font-size: 1.5rem; color: #fff; margin-bottom: 10px; }
        .empty-inv p { color: #999; margin-bottom: 25px; font-size: 1rem; }

        /* --- MODALS (PREVIEW & ROULETTE) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal-content {
            background: #1a1d24; width: 95%; max-width: 450px; border-radius: 24px; padding: 40px;
            position: relative; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 50px 120px rgba(0,0,0,0.9);
            transform: scale(0.95) translateY(20px);
            transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }

        .close-btn {
            position: absolute; top: 20px; right: 20px; z-index: 10;
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255,255,255,0.05); color: #fff; border: none;
            font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .close-btn:hover { background: #e74c3c; }

        /* Info Modal Visuals */
        .modal-visual {
            height: 200px; width: 100%;
            background: radial-gradient(circle at center, #232732 0%, #1a1d24 100%);
            display: flex; justify-content: center; align-items: center;
            border-radius: 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05);
        }
        .modal-img { max-width: 60%; max-height: 80%; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.5)); }
        .modal-emoji { font-size: 6rem; }

        .modal-body h2 { font-size: 1.6rem; margin: 0 0 5px; color: #fff; font-weight: 800; text-align: center; }
        .modal-type { display: block; text-align: center; font-size: 0.7rem; color: #5865F2; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; margin-bottom: 15px; }
        .modal-desc { text-align: center; color: #9ca3af; font-size: 0.9rem; line-height: 1.5; padding: 0 10px; }
        .modal-info-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 12px 20px; border-radius: 12px; color: #aaa; font-weight: 600; margin-top: 10px; }
        .full-width { width: 100%; padding: 14px; font-size: 1rem; border-radius: 12px; margin-top: 10px; }
        .unusable-badge { padding: 12px; background: rgba(255,255,255,0.05); color: #666; border-radius: 10px; font-size: 0.85rem; text-align: center; margin-top: 10px; }

        /* Roulette & Rewards */
        .lootbox-content { max-width: 600px; padding: 40px 30px; text-align: center; }
        .spin-title { color: #FFD700; font-size: 1.8rem; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; animation: pulse 1s infinite alternate; }
        .roulette-wrapper { width: 100%; height: 110px; background: #050505; border: 2px solid #333; border-radius: 12px; margin-bottom: 30px; position: relative; overflow: hidden; }
        .roulette-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 3px; height: 100%; background: #FFD700; z-index: 10; box-shadow: 0 0 15px #FFD700; }
        .roulette-window { height: 100%; display: flex; align-items: center; }
        .roulette-strip { display: flex; gap: 8px; padding-left: 50%; will-change: transform; }
        .roulette-card { width: 80px; height: 80px; flex-shrink: 0; background: #1e1e24; border-bottom: 4px solid #555; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; }
        .roulette-card.common { border-color: #95a5a6; }
        .roulette-card.uncommon { border-color: #2ecc71; }
        .roulette-card.rare { border-color: #3498db; }
        .roulette-card.epic { border-color: #9b59b6; }
        .roulette-card.legendary { border-color: #FFD700; background: radial-gradient(circle, rgba(255,215,0,0.2), #1a1a20); }
        .spin-actions { display: flex; justify-content: center; }
        #btnSkip { background: rgba(255,255,255,0.1); color: #fff; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 700; cursor: pointer; }

        .reward-content { text-align: center; padding: 40px 30px; }
        .reward-content h2 { color: #FFD700; font-size: 2rem; text-transform: uppercase; margin-bottom: 10px; animation: popIn 0.6s; }
        .rewards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 40px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .reward-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; gap: 10px; animation: slideUp 0.5s ease forwards; opacity: 0; }
        .rew-icon { font-size: 2.5rem; }
        .rew-name { font-size: 0.8rem; font-weight: 700; color: #fff; }
        .rew-qty { color: #FFD700; font-weight: 800; background: rgba(255, 215, 0, 0.15); padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; }
        .big-btn { width: 100%; padding: 15px; background: #2ecc71; color: #fff; border: none; border-radius: 12px; font-weight: 800; text-transform: uppercase; cursor: pointer; box-shadow: 0 10px 30px rgba(46,204,113,0.3); }
        .confetti-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background-image: radial-gradient(#FFD700 3px, transparent 3px), radial-gradient(#ff0055 3px, transparent 3px); background-size: 40px 40px; opacity: 0.15; animation: confettiFall 10s linear infinite; }

        @keyframes confettiFall { 0% { background-position: 0 0, 20px 20px; } 100% { background-position: 0 400px, 20px 420px; } }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }

        /* Mobile */
        @media (max-width: 600px) {
            /* 2 –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
            .inv-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; } 
            .inv-card { min-height: 180px; padding: 10px; }
            .inv-emoji { font-size: 2.5rem; }
            .inv-img { max-height: 60px; }
            .inv-name { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="inv-wrapper">
        
        <header class="inv-header">
            <div class="inv-title">
                <h1>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h1>
                <span class="inv-count"><%= inventory.length %> –ø—Ä–µ–¥–º–µ—Ç–æ–≤</span>
            </div>

            <nav class="inv-tabs" aria-label="–§–∏–ª—å—Ç—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è">
                <button class="tab-btn active" onclick="filterInv('all', this)">–í—Å–µ</button>
                <button class="tab-btn" onclick="filterInv('–õ—É—Ç–±–æ–∫—Å', this)">–õ—É—Ç–±–æ–∫—Å—ã</button>
                <button class="tab-btn" onclick="filterInv('–†–∞—Å—Ö–æ–¥–Ω–∏–∫', this)">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</button>
                <button class="tab-btn" onclick="filterInv('–ö–æ—Å–º–µ—Ç–∏–∫–∞', this)">–ö–æ—Å–º–µ—Ç–∏–∫–∞</button>
                <button class="tab-btn" onclick="filterInv('–†–µ—Å—É—Ä—Å', this)">–†–µ—Å—É—Ä—Å—ã</button>
            </nav>

            <div class="inv-stats">
                <div class="inv-stat">
                    <span>–ë–∞–ª–∞–Ω—Å:</span>
                    <strong style="color: #ffd700;"><%= Math.floor(profile.stars).toLocaleString() %> ‚≠ê</strong>
                </div>
                <a href="/shop" class="btn-secondary" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω"><i class="fas fa-shopping-cart"></i> –ú–∞–≥–∞–∑–∏–Ω</a>
            </div>
        </header>

        <h2 class="sr-only">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h2>

        <div class="inv-grid-container">
            <% if (inventory.length > 0) { %>
                <div class="inv-grid" id="invGrid">
                    <% 
                    // –ö–∞—Ä—Ç–∞ –∞—Å—Å–µ—Ç–æ–≤ (–¥—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è)
                    const assetMap = {
                        'profile_frame_veteran': 'veteran',
                        'profile_frame_laurel_blue': 'laurel_blue',
                        'profile_frame_patterned_bronze': 'patterned_bronze',
                        'premium_avatar_frame_gold_plated': 'premium_gold_plated',
                        'avatar_frame_azure_spark': 'azure_spark',
                        'hween_frame_web': 'halloween_web',
                        'profile_bg_legend': 'legend',
                        'profile_bg_stars_dark': 'stars_dark',
                        'premium_card_bg_galaxy': 'premium_galaxy',
                        'hween_bg_pumpkins': 'halloween_pumpkins'
                    };

                    inventory.forEach((slot, index) => { 
                       let rarity = 'common';
                        const cat = slot.details.category;
                        const name = slot.details.name.toLowerCase(); // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ

                        if (name.includes('–ª–µ–≥–µ–Ω–¥–∞—Ä') || name.includes('–º–∏—Ñ–∏—á') || cat === '–õ—É—Ç–±–æ–∫—Å') rarity = 'legendary';
                        else if (name.includes('—Ä–µ–¥–∫–∏–π') || cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è') rarity = 'epic';
                        else if (name.includes('–Ω–µ–æ–±—ã—á–Ω—ã–π')) rarity = 'rare';

                        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–¢–ò–ù–û–ö ---
                        let imageUrl = null;
                        let showEmoji = true;

                        // [FIX] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∑–Ω–∞—á–∫–∞ "–°–µ—Ä–µ–±—Ä—è–Ω–∞—è –ó–≤–µ–∑–¥–∞"
                        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π –∑–Ω–∞—á–æ–∫ -> –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏
                        if (name.includes("–∑–Ω–∞—á–æ–∫") && name.includes("—Å–µ—Ä–µ–±—Ä—è–Ω–∞—è –∑–≤–µ–∑–¥–∞")) {
                             imageUrl = null;
                             showEmoji = true;
                        } 
                        else if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–ö–æ—Å–º–µ—Ç–∏–∫–∞') {
                            let filename = assetMap[slot.itemId];
                            if (!filename) filename = slot.itemId.replace('profile_frame_', '').replace('profile_bg_', '');
                            
                            let folder = slot.itemId.includes('frame') ? 'frames' : 'backgrounds';
                            if (slot.itemId.includes('bg')) folder = 'backgrounds';
                            
                            imageUrl = `/assets/thumbnails/${folder}/${filename}.webp`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
                            showEmoji = false;
                        } else if (slot.details.imageUrl_web) {
                            imageUrl = slot.details.imageUrl_web;
                            showEmoji = false;
                        }
                    %>
                        <div class="inv-card <%= rarity %>" 
                             onclick="openItemModal(<%= index %>)" 
                             data-category="<%= cat %>"
                             tabindex="0"
                             role="button"
                             aria-label="<%= slot.details.name %>">
                            
                            <div class="inv-badge">x<%= slot.quantity %></div>

                            <div class="inv-visual">
                                <% if (!showEmoji && imageUrl) { %>
                                    <img src="<%= imageUrl %>" class="inv-img" alt="<%= slot.details.name %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div class="inv-emoji" style="display: none;" role="img"><%= slot.details.emoji %></div>
                                <% } else { %>
                                    <div class="inv-emoji" role="img"><%= slot.details.emoji %></div>
                                <% } %>
                            </div>
                            
                            <div class="inv-info">
                                <h3 class="inv-name"><%= slot.details.name %></h3>
                                <div class="inv-type"><%= cat %></div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="empty-inv">
                    <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                    <h3>–ü—É—Å—Ç–æ...</h3>
                    <p>–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç.</p>
                    <a href="/shop" class="btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º</a>
                </div>
            <% } %>
        </div>
    </div>

    <div id="itemModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-labelledby="mName">
            <button class="close-btn" onclick="closeModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å"><i class="fas fa-times"></i></button>
            
            <div class="modal-visual" id="mVisual"></div>

            <div class="modal-body">
                <h2 id="mName">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
                <span class="modal-type" id="mType">–¢–∏–ø</span>
                <p id="mDesc" class="modal-desc">–û–ø–∏—Å–∞–Ω–∏–µ...</p>
                
                <div class="modal-info-row">
                    <span>–í –Ω–∞–ª–∏—á–∏–∏:</span>
                    <strong id="mQty" style="color: #fff;">x0</strong>
                </div>

                <div class="modal-actions" id="mActions"></div>
            </div>
        </div>
    </div>

    <div id="lootboxModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content lootbox-content">
            <h2 class="spin-title">–û–¢–ö–†–´–¢–ò–ï...</h2>
            <div class="roulette-wrapper">
                <div class="roulette-pointer"></div>
                <div class="roulette-window">
                    <div class="roulette-strip" id="rouletteStrip"></div>
                </div>
            </div>
            <div class="spin-actions">
                <button class="btn-secondary" id="btnSkip" onclick="skipSpin()">SKIP >></button>
            </div>
        </div>
    </div>

    <div id="rewardModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content reward-content">
            <div class="confetti-wrapper"></div>
            <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
            <p class="reward-subtitle">–í—ã –ø–æ–ª—É—á–∏–ª–∏:</p>
            <div class="rewards-grid" id="rewardsList"></div>
            <button class="btn-primary big-btn" onclick="location.reload()">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
        const inventoryData = <%- JSON.stringify(inventory) %>;
        let currentItem = null;
        let spinTimer = null;
        let currentRewards = [];

        function filterInv(category, btn) {
            const cards = document.querySelectorAll('.inv-card');
            const buttons = document.querySelectorAll('.tab-btn');

            if (btn) {
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            cards.forEach(card => {
                const cat = card.getAttribute('data-category');
                let match = false;
                if (category === 'all') match = true;
                else if (category === '–ö–æ—Å–º–µ—Ç–∏–∫–∞' && (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–¢–∏—Ç—É–ª')) match = true;
                else if (cat.includes(category)) match = true;
                card.style.display = match ? 'flex' : 'none';
            });
        }

        function openItemModal(index) {
            const item = inventoryData[index];
            currentItem = item;
            document.getElementById('mName').innerText = item.details.name;
            document.getElementById('mDesc').innerText = item.details.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            document.getElementById('mType').innerText = item.details.category;
            document.getElementById('mQty').innerText = 'x' + item.quantity;

            const visualDiv = document.getElementById('mVisual');
            
            // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏
let imageUrl = null;
            const cat = item.details.category;
            const lowerName = item.details.name.toLowerCase(); // –î–æ–±–∞–≤–ª—è–µ–º lowerName

            // [FIX] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            if (lowerName.includes("–∑–Ω–∞—á–æ–∫") && lowerName.includes("—Å–µ—Ä–µ–±—Ä—è–Ω–∞—è –∑–≤–µ–∑–¥–∞")) {
                imageUrl = null;
            } else if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–ö–æ—Å–º–µ—Ç–∏–∫–∞') {
                let cleanId = item.itemId;
                let folder = 'frames';
                if (item.itemId.startsWith('profile_frame_')) {
                    cleanId = item.itemId.replace('profile_frame_', '');
                    folder = 'frames';
                } else if (item.itemId.startsWith('profile_bg_')) {
                    cleanId = item.itemId.replace('profile_bg_', '');
                    folder = 'backgrounds';
                }
                imageUrl = `/assets/${folder}/${cleanId}.webp`;
            } else if (item.details.imageUrl_web) {
                imageUrl = item.details.imageUrl_web;
            }

            if (imageUrl) {
                visualDiv.innerHTML = `<img src="${imageUrl}" class="modal-img" alt="${item.details.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div class="modal-emoji" style="display:none">${item.details.emoji}</div>`;
            } else {
                visualDiv.innerHTML = `<div class="modal-emoji">${item.details.emoji}</div>`;
            }

            const actionsDiv = document.getElementById('mActions');
            actionsDiv.innerHTML = '';

            const usableCats = ['–õ—É—Ç–±–æ–∫—Å', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫', '–ù–∞–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤'];
            const isUsable = usableCats.includes(cat) || item.details.isUsable;

            if (isUsable) {
                const btnLabel = (cat === '–õ—É—Ç–±–æ–∫—Å' || cat === '–ù–∞–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤') ? '–û—Ç–∫—Ä—ã—Ç—å' : '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å';
                const btn = document.createElement('button');
                btn.className = 'btn-primary full-width';
                btn.innerText = btnLabel;
                btn.onclick = () => useItem(item.itemId);
                actionsDiv.appendChild(btn);
            } else {
                const info = document.createElement('div');
                info.className = 'unusable-badge';
                info.innerText = '–ü—Ä–µ–¥–º–µ—Ç –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è';
                actionsDiv.appendChild(info);
            }

            document.getElementById('itemModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        }

        async function useItem(itemId) {
            if (typeof Modal !== 'undefined') {
                const confirmed = await Modal.confirm("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ", "–í—ã —É–≤–µ—Ä–µ–Ω—ã?");
                if (!confirmed) return;
            } else if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
            
            document.getElementById('itemModal').classList.remove('active');

            try {
                const res = await fetch('/api/inventory/use', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ itemId: itemId, quantity: 1 })
                });
                const result = await res.json();

                if (result.success) {
                    if (result.type === 'lootbox') {
                        currentRewards = result.rewards;
                        startRoulette(result.rewards[0]);
                    } else {
                        if (typeof Modal !== 'undefined') await Modal.alert("–£—Å–ø–µ—à–Ω–æ", result.message, "success");
                        else alert(result.message);
                        location.reload();
                    }
                } else {
                    if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", result.error, "error");
                    else alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (e) {
                if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", "error");
            }
        }

        // ROULETTE LOGIC
        const DUMMY_ITEMS = [
            { emoji: 'üß©', color: 'common' }, { emoji: 'üí°', color: 'uncommon' },
            { emoji: '‚≠ê', color: 'rare' }, { emoji: 'üíé', color: 'epic' },
            { emoji: 'üçÄ', color: 'rare' }
        ];

        function startRoulette(winningItem) {
            const modal = document.getElementById('lootboxModal');
            const strip = document.getElementById('rouletteStrip');
            const skipBtn = document.getElementById('btnSkip');
            modal.classList.add('active');
            skipBtn.style.display = 'block';
            
            strip.innerHTML = '';
            strip.style.transition = 'none';
            strip.style.transform = 'translateX(0)';
            
            const TOTAL_ITEMS = 50;
            const WIN_INDEX = 40;
            const CARD_WIDTH = 90; 
            const GAP = 10;

            for (let i = 0; i < TOTAL_ITEMS; i++) {
                let itemData;
                if (i === WIN_INDEX) {
                    itemData = { emoji: winningItem.emoji || 'üéÅ', color: 'legendary' };
                } else {
                    itemData = DUMMY_ITEMS[Math.floor(Math.random() * DUMMY_ITEMS.length)];
                }
                const card = document.createElement('div');
                card.className = `roulette-card ${itemData.color}`;
                card.innerHTML = itemData.emoji;
                strip.appendChild(card);
            }

            setTimeout(() => {
                const centerOffset = (document.querySelector('.roulette-window').offsetWidth / 2) - (CARD_WIDTH / 2);
                const randomOffset = Math.floor(Math.random() * 60) - 30; 
                const targetPos = (WIN_INDEX * (CARD_WIDTH + GAP)) - centerOffset + randomOffset;

                strip.style.transition = 'transform 5s cubic-bezier(0.15, 0, 0.10, 1)';
                strip.style.transform = `translateX(-${targetPos}px)`;

                spinTimer = setTimeout(() => { finishSpin(); }, 5000);
            }, 100);
        }

        function skipSpin() {
            if (spinTimer) clearTimeout(spinTimer);
            finishSpin();
        }

        function finishSpin() {
            document.getElementById('lootboxModal').classList.remove('active');
            showRewards(currentRewards);
        }

        function showRewards(rewards) {
            const list = document.getElementById('rewardsList');
            list.innerHTML = '';
            rewards.forEach(r => {
                const div = document.createElement('div');
                div.className = 'reward-card';
                div.innerHTML = `<div class="rew-icon">${r.emoji || 'üéÅ'}</div>
                                 <div class="rew-details"><span class="rew-name">${r.name}</span><span class="rew-qty">x${r.quantity}</span></div>`;
                list.appendChild(div);
            });
            document.getElementById('rewardModal').classList.add('active');
        }
        
        window.onclick = function(e) {
            if (e.target.classList.contains('modal-overlay') && e.target.id !== 'lootboxModal') closeModal();
        }
    </script>
</body>
</html>