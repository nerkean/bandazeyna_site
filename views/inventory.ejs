<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å | –î–∞—á–∞ –ó–µ–π–Ω–∞' }) %>
    <link rel="stylesheet" href="/css/inventory.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="inv-wrapper">
        
        <header class="inv-header">
            <div class="inv-title">
                <h1>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h1>
                <span class="inv-count"><%= inventory.length %> –ø—Ä–µ–¥–º–µ—Ç–æ–≤</span>
            </div>

            <nav class="inv-tabs" aria-label="–§–∏–ª—å—Ç—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è">
                <button class="tab-btn active" data-filter="all">–í—Å–µ</button>
                <button class="tab-btn" data-filter="–õ—É—Ç–±–æ–∫—Å">–õ—É—Ç–±–æ–∫—Å—ã</button>
                <button class="tab-btn" data-filter="–†–∞—Å—Ö–æ–¥–Ω–∏–∫">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</button>
                <button class="tab-btn" data-filter="–ö–æ—Å–º–µ—Ç–∏–∫–∞">–ö–æ—Å–º–µ—Ç–∏–∫–∞</button>
                <button class="tab-btn" data-filter="–†–µ—Å—É—Ä—Å">–†–µ—Å—É—Ä—Å—ã</button>
            </nav>

            <div class="inv-stats">
                <div class="inv-stat">
                    <span>–ë–∞–ª–∞–Ω—Å:</span>
                    <strong style="color: #ffd700;"><%= Math.floor(profile.stars).toLocaleString() %> ‚≠ê</strong>
                </div>
                <a href="/shop" class="btn-secondary" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω"><i class="fas fa-shopping-cart"></i> –ú–∞–≥–∞–∑–∏–Ω</a>
            </div>
        </header>

        <h2 class="sr-only">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h2>

        <div class="inv-grid-container">
            <% if (inventory.length > 0) { %>
                <div class="inv-grid" id="invGrid">
                    <% 
                    const assetMap = {
                        'profile_frame_veteran': 'veteran',
                        'profile_frame_laurel_blue': 'laurel_blue',
                        'profile_frame_patterned_bronze': 'patterned_bronze',
                        'premium_avatar_frame_gold_plated': 'premium_gold_plated',
                        'avatar_frame_azure_spark': 'azure_spark',
                        'hween_frame_web': 'halloween_web',
                        'profile_bg_legend': 'legend',
                        'profile_bg_stars_dark': 'stars_dark',
                        'premium_card_bg_galaxy': 'premium_galaxy',
                        'hween_bg_pumpkins': 'halloween_pumpkins'
                    };

                    inventory.forEach((slot, index) => { 
                       let rarity = 'common';
                        const cat = slot.details.category;
                        const name = slot.details.name.toLowerCase(); 

                        if (name.includes('–ª–µ–≥–µ–Ω–¥–∞—Ä') || name.includes('–º–∏—Ñ–∏—á') || cat === '–õ—É—Ç–±–æ–∫—Å') rarity = 'legendary';
                        else if (name.includes('—Ä–µ–¥–∫–∏–π') || cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è') rarity = 'epic';
                        else if (name.includes('–Ω–µ–æ–±—ã—á–Ω—ã–π')) rarity = 'rare';

                        let imageUrl = null;
                        let showEmoji = true;

                        if (name.includes("–∑–Ω–∞—á–æ–∫") && name.includes("—Å–µ—Ä–µ–±—Ä—è–Ω–∞—è –∑–≤–µ–∑–¥–∞")) {
                             imageUrl = null;
                             showEmoji = true;
                        } 
                        else if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–ö–æ—Å–º–µ—Ç–∏–∫–∞') {
                            let filename = assetMap[slot.itemId];
                            if (!filename) filename = slot.itemId.replace('profile_frame_', '').replace('profile_bg_', '');
                            
                            let folder = slot.itemId.includes('frame') ? 'frames' : 'backgrounds';
                            if (slot.itemId.includes('bg')) folder = 'backgrounds';
                            
                            imageUrl = `/assets/thumbnails/${folder}/${filename}.webp`; 
                            showEmoji = false;
                        } else if (slot.details.imageUrl_web) {
                            imageUrl = slot.details.imageUrl_web;
                            showEmoji = false;
                        }
                    %>
                        <div class="inv-card <%= rarity %> item-trigger" 
                             data-index="<%= index %>"
                             data-category="<%= cat %>"
                             tabindex="0"
                             role="button"
                             aria-label="<%= slot.details.name %>">
                            
                            <div class="inv-badge">x<%= slot.quantity %></div>

                            <div class="inv-visual">
                                <% if (!showEmoji && imageUrl) { %>
                                    <img src="<%= imageUrl %>" class="inv-img" alt="<%= slot.details.name %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div class="inv-emoji" style="display: none;" role="img"><%= slot.details.emoji %></div>
                                <% } else { %>
                                    <div class="inv-emoji" role="img"><%= slot.details.emoji %></div>
                                <% } %>
                            </div>
                            
                            <div class="inv-info">
                                <h3 class="inv-name"><%= slot.details.name %></h3>
                                <div class="inv-type"><%= cat %></div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="empty-inv">
                    <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                    <h3>–ü—É—Å—Ç–æ...</h3>
                    <p>–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç.</p>
                    <a href="/shop" class="btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º</a>
                </div>
            <% } %>
        </div>
    </div>

    <div id="itemModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-labelledby="mName">
            <button class="close-btn" id="closeItemModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"><i class="fas fa-times"></i></button>
            
            <div class="modal-visual" id="mVisual"></div>

            <div class="modal-body">
                <h2 id="mName">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
                <span class="modal-type" id="mType">–¢–∏–ø</span>
                <p id="mDesc" class="modal-desc">–û–ø–∏—Å–∞–Ω–∏–µ...</p>
                
                <div class="modal-info-row">
                    <span>–í –Ω–∞–ª–∏—á–∏–∏:</span>
                    <strong id="mQty" style="color: #fff;">x0</strong>
                </div>

                <div class="modal-actions" id="mActions"></div>
            </div>
        </div>
    </div>

    <div id="lootboxModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content lootbox-content">
            <h2 class="spin-title">–û–¢–ö–†–´–¢–ò–ï...</h2>
            <div class="roulette-wrapper">
                <div class="roulette-pointer"></div>
                <div class="roulette-window">
                    <div class="roulette-strip" id="rouletteStrip"></div>
                </div>
            </div>
            <div class="spin-actions">
                <button class="btn-secondary" id="btnSkip">SKIP >></button>
            </div>
        </div>
    </div>

    <div id="rewardModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content reward-content">
            <div class="confetti-wrapper"></div>
            <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
            <p class="reward-subtitle">–í—ã –ø–æ–ª—É—á–∏–ª–∏:</p>
            <div class="rewards-grid" id="rewardsList"></div>
            <button class="btn-primary big-btn" id="btnCollect">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script nonce="<%= nonce %>">
        const inventoryData = <%- JSON.stringify(inventory) %>;
        let currentItem = null;
        let spinTimer = null;
        let currentRewards = [];

        document.addEventListener('DOMContentLoaded', () => {
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filterInv(btn.dataset.filter);
                });
            });

            document.querySelectorAll('.item-trigger').forEach(card => {
                card.addEventListener('click', () => openItemModal(card.dataset.index));
            });

            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });
            
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay && overlay.id !== 'lootboxModal') closeModal();
                });
            });

            document.getElementById('btnSkip').addEventListener('click', skipSpin);
            document.getElementById('btnCollect').addEventListener('click', () => location.reload());
        });

        function filterInv(category) {
            const cards = document.querySelectorAll('.inv-card');
            cards.forEach(card => {
                const cat = card.getAttribute('data-category');
                let match = false;
                if (category === 'all') match = true;
                else if (category === '–ö–æ—Å–º–µ—Ç–∏–∫–∞' && (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–¢–∏—Ç—É–ª')) match = true;
                else if (cat.includes(category)) match = true;
                card.style.display = match ? 'flex' : 'none';
            });
        }

        function openItemModal(index) {
            const item = inventoryData[index];
            currentItem = item;
            
            document.getElementById('mName').innerText = item.details.name;
            document.getElementById('mDesc').innerText = item.details.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            document.getElementById('mType').innerText = item.details.category;
            document.getElementById('mQty').innerText = 'x' + item.quantity;

            const visualDiv = document.getElementById('mVisual');
            let imageUrl = null;
            const cat = item.details.category;
            if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–ö–æ—Å–º–µ—Ç–∏–∫–∞') {
                let cleanId = item.itemId.replace('profile_frame_', '').replace('profile_bg_', '');
                let folder = item.itemId.includes('bg') ? 'backgrounds' : 'frames';
                imageUrl = `/assets/thumbnails/${folder}/${cleanId}.webp`;
            } else if (item.details.imageUrl_web) {
                imageUrl = item.details.imageUrl_web;
            }

            if (imageUrl) {
                visualDiv.innerHTML = `<img src="${imageUrl}" class="modal-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div class="modal-emoji" style="display:none">${item.details.emoji}</div>`;
            } else {
                visualDiv.innerHTML = `<div class="modal-emoji">${item.details.emoji}</div>`;
            }

            const actionsDiv = document.getElementById('mActions');
            actionsDiv.innerHTML = '';

            const usableCats = ['–õ—É—Ç–±–æ–∫—Å', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫', '–ù–∞–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤', '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è'];

            const isUsable = usableCats.includes(cat) || item.details.isUsable;

            if (isUsable) {
                const btnLabel = (cat === '–õ—É—Ç–±–æ–∫—Å' || cat === '–ù–∞–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤') ? '–û—Ç–∫—Ä—ã—Ç—å' : '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å';
                const btn = document.createElement('button');
                btn.className = 'btn-primary full-width';
                btn.innerText = btnLabel;
        
                btn.addEventListener('click', () => useItem(item.itemId, item.details.name));
                
                actionsDiv.appendChild(btn);
            } else {
                const info = document.createElement('div');
                info.className = 'unusable-badge';
                info.innerText = '–ü—Ä–µ–¥–º–µ—Ç –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è';
                actionsDiv.appendChild(info);
            }

            document.getElementById('itemModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        }

        async function useItem(itemId, itemName) {
            closeModal(); 

            if (typeof Modal !== 'undefined') {
                const confirmed = await Modal.confirm("–î–µ–π—Å—Ç–≤–∏–µ", `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <b>${itemName}</b>?`);
                if (!confirmed) return;
            } else if (!confirm(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ${itemName}?`)) return;

            try {
                const res = await fetch('/api/inventory/use', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ itemId: itemId, quantity: 1 })
                });
                const result = await res.json();

                if (result.success) {
                    if (result.rewards && result.rewards.length > 0) {
                        currentRewards = result.rewards;
                        startRoulette(result.rewards[0]);
                    } else {
                        if (typeof Modal !== 'undefined') await Modal.alert("–£—Å–ø–µ—à–Ω–æ", result.message, "success");
                        else alert(result.message);
                        location.reload();
                    }
                } else {
                    if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", result.error, "error");
                    else alert(result.error);
                }
            } catch (e) {
                if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", "–°–±–æ–π —Å–µ—Ç–∏", "error");
            }
        }

        const DUMMY_ITEMS = [
            { emoji: 'üß©', color: 'common' }, { emoji: 'üí°', color: 'uncommon' },
            { emoji: '‚≠ê', color: 'rare' }, { emoji: 'üíé', color: 'epic' },
            { emoji: 'üçÄ', color: 'rare' }
        ];

        function startRoulette(winningItem) {
            const modal = document.getElementById('lootboxModal');
            const strip = document.getElementById('rouletteStrip');
            const skipBtn = document.getElementById('btnSkip');
            
            modal.classList.add('active');
            skipBtn.style.display = 'block';
            
            strip.innerHTML = '';
            strip.style.transition = 'none';
            strip.style.transform = 'translateX(0)';
            
            const TOTAL_ITEMS = 50;
            const WIN_INDEX = 40;

            for (let i = 0; i < TOTAL_ITEMS; i++) {
                let itemData;
                if (i === WIN_INDEX) {
                    itemData = { emoji: winningItem.emoji || 'üéÅ', color: 'legendary' };
                } else {
                    itemData = DUMMY_ITEMS[Math.floor(Math.random() * DUMMY_ITEMS.length)];
                }
                const card = document.createElement('div');
                card.className = `roulette-card ${itemData.color}`;
                card.innerHTML = itemData.emoji;
                strip.appendChild(card);
            }

            setTimeout(() => {
                const CARD_WIDTH = 80 + 10;
                const targetPos = (WIN_INDEX * CARD_WIDTH) - (document.querySelector('.roulette-window').offsetWidth / 2) + 40;

                strip.style.transition = 'transform 5s cubic-bezier(0.1, 0, 0.1, 1)'; 
                strip.style.transform = `translateX(-${targetPos}px)`;

                spinTimer = setTimeout(() => { finishSpin(); }, 5000);
            }, 100);
        }

        function skipSpin() {
            if (spinTimer) clearTimeout(spinTimer);
            finishSpin();
        }

        function finishSpin() {
            document.getElementById('lootboxModal').classList.remove('active');
            showRewards(currentRewards);
        }

        function showRewards(rewards) {
            const list = document.getElementById('rewardsList');
            list.innerHTML = '';
            rewards.forEach(r => {
                const div = document.createElement('div');
                div.className = 'reward-card';
                div.innerHTML = `
                    <div class="rew-icon">${r.emoji || 'üéÅ'}</div>
                    <div class="rew-name">${r.name}</div>
                    <div class="rew-qty">x${r.quantity}</div>
                `;
                list.appendChild(div);
            });
            document.getElementById('rewardModal').classList.add('active');
        }
    </script>
</body>
</html>