<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: 'Редактор Wiki' }) %>
    <style>
        .editor-wrap { max-width: 800px; margin: 120px auto; padding: 0 20px 100px; }
        .editor-card { background: #16181e; padding: 40px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; color: #aaa; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px; border-radius: 12px; color: #fff; font-family: inherit; font-size: 1rem;
            transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: #5865F2; outline: none; }
        
        .row { display: flex; gap: 20px; }
        .col { flex: 1; }

        .help-text { font-size: 0.8rem; color: #666; margin-top: 5px; }

        /* Переключатель (Toggle) */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; border-radius: 24px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: #5865F2; }
        input:checked + .slider:before { transform: translateX(26px); }

        .toolbar {
            display: flex; gap: 10px; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;
        }
        .tool-btn {
            background: none; border: 1px solid rgba(255,255,255,0.1); color: #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }
        .tool-btn:hover { background: #fff; color: #000; }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="editor-wrap">
        <div class="editor-card">
            <h1 style="margin-bottom: 30px;"><%= article ? 'Редактирование' : 'Новая статья' %></h1>
            
            <form id="wikiForm">
                <% if (article) { %>
                    <input type="hidden" name="id" value="<%= article._id %>">
                <% } %>

                <div class="row">
                    <div class="col form-group">
                        <label>Заголовок</label>
                        <input type="text" name="title" value="<%= article ? article.title : '' %>" required placeholder="Например: Diamond Mask">
                    </div>
                    <div class="col form-group">
                        <label>Slug (Ссылка)</label>
                        <input type="text" name="slug" value="<%= article ? article.slug : '' %>" placeholder="diamond-mask (оставь пустым для авто)">
                    </div>
                </div>

                <div class="row">
                    <div class="col form-group">
                        <label>Категория</label>
                        <select name="category">
                            <option value="guides" <%= article && article.category=='guides'?'selected':'' %>>Гайды</option>
                            <option value="items" <%= article && article.category=='items'?'selected':'' %>>Предметы</option>
                            <option value="bees" <%= article && article.category=='bees'?'selected':'' %>>Пчелы</option>
                            <option value="mechanics" <%= article && article.category=='mechanics'?'selected':'' %>>Механики</option>
                            <option value="server" <%= article && article.category=='server'?'selected':'' %>>О Сервере</option>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label>Иконка (FontAwesome)</label>
                        <input type="text" name="icon" value="<%= article ? article.icon : 'fas fa-book' %>">
                    </div>
                </div>

                <div class="form-group">
                    <label>Краткое описание (для превью)</label>
                    <input type="text" name="description" value="<%= article ? article.description : '' %>" required>
                </div>

                <div class="form-group">
                    <label>Контент (HTML)</label>
                    <div class="toolbar">
                        <button type="button" class="tool-btn" onclick="insertTag('<h2>', '</h2>')">H2</button>
                        <button type="button" class="tool-btn" onclick="insertTag('<h3>', '</h3>')">H3</button>
                        <button type="button" class="tool-btn" onclick="insertTag('<b>', '</b>')">B</button>
                        <button type="button" class="tool-btn" onclick="insertTag('<i>', '</i>')">I</button>
                        <button type="button" class="tool-btn" onclick="insertTag('<ul>\n<li>', '</li>\n</ul>')">List</button>
                        <button type="button" class="tool-btn" onclick="insertTag('<code>', '</code>')">Code</button>
                        <button type="button" class="tool-btn" onclick="insertTag('<div class=\'note\'>', '</div>')">Note</button>
                    </div>
                    <textarea name="content" id="contentArea" rows="15" required><%= article ? article.content : '' %></textarea>
                    <div class="help-text">Поддерживается HTML. Используйте классы для стилизации.</div>
                </div>

                <div class="row">
                    <div class="col form-group">
                        <label>Теги (через запятую)</label>
                        <input type="text" name="tags" value="<%= article ? article.tags.join(', ') : '' %>" placeholder="blue, mythic, endgame">
                    </div>
                                        <div class="col form-group">
                        <label>Главная картинка (Превью)</label>
                        <input type="file" name="mainImage" accept="image/*">
                        
                        <input type="hidden" name="currentImage" value="<%= article ? article.image : '' %>">

                        <% if (article && article.image) { %>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; display: inline-block;">
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">Текущая:</div>
                                <img src="<%= article.image %>" style="height: 80px; border-radius: 6px; display: block;">
                            </div>
                        <% } %>
                    </div>
                    <div class="col form-group">
                        <label>Галерея (Картинки)</label>
                        <input type="file" name="gallery" multiple accept="image/*">
                        <div class="help-text">Можно выбрать несколько. Они добавятся к существующим.</div>
                    </div>
                    <div class="col form-group">
                        <label>Вложения (Файлы)</label>
                        <input type="file" name="files" multiple>
                        <div class="help-text">Файлы для скачивания (PDF, Configs, ZIP).</div>
                    </div>
                </div>

                <div class="form-group" style="display: flex; align-items: center; gap: 15px;">
                    <label class="switch">
                        <input type="checkbox" name="isPublished" <%= (article && article.isPublished) || !article ? 'checked' : '' %>>
                        <span class="slider"></span>
                    </label>
                    <span style="color: #fff; font-weight: 700;">Опубликовать сразу</span>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 20px;">
                    <button type="submit" class="btn-primary" style="flex: 1;">Сохранить Статью</button>
                    <a href="/admin/wiki" class="btn-secondary" style="width: auto;">Отмена</a>
                </div>
            </form>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script nonce="<%= nonce %>">
        function insertTag(open, close) {
            const textarea = document.getElementById('contentArea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.substring(start, end);
            const replacement = open + selected + close;
            textarea.value = text.substring(0, start) + replacement + text.substring(end);
            textarea.focus();
            textarea.selectionEnd = start + open.length + selected.length; 
        }

        document.getElementById('wikiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Создаем FormData. Он автоматически соберет файлы из <input type="file">
            const formData = new FormData(e.target);
            
            // Чекбокс isPublished в FormData передается только если включен, 
            // но нам нужно явное значение.
            formData.set('isPublished', e.target.isPublished.checked);

            try {
                const res = await fetch('/api/admin/wiki', {
                    method: 'POST',
                    // ВАЖНО: Не указываем Content-Type header вручную! 
                    // Браузер сам поставит multipart/form-data и boundary.
                    body: formData 
                });
                const result = await res.json();
                
                if (result.success) {
                    alert('Статья сохранена!');
                    window.location.href = '/admin/wiki';
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (err) {
                console.error(err);
                alert('Ошибка сети');
            }
        });
    </script>
</body>
</html>