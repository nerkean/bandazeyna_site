<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã' }) %>
    
    <link rel="preload" href="/css/daily.css" as="style">
    <link rel="stylesheet" href="/css/daily.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <canvas id="confetti-canvas"></canvas>

    <div class="daily-wrapper">
        
        <header class="d-header">
            <h1>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ù–∞–≥—Ä–∞–¥—ã</h1>
            <p>–ó–∞—Ö–æ–¥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å–µ—Ä–∏—é!</p>
        </header>

        <div class="streak-badge">
            <span class="s-fire">üî•</span>
            <span class="s-text">–°–µ—Ä–∏—è: <span><%= streak %></span> –¥–Ω–µ–π</span>
        </div>

        <div class="rewards-track" role="list">
            <% rewards.forEach(r => { %>
                <% 
                    let statusClass = '';
                    if (r.day < currentDay) {
                        statusClass = 'claimed'; 
                    } else if (r.day === currentDay) {
                        statusClass = canClaim ? 'active' : 'claimed'; 
                    } else {
                        statusClass = 'locked';
                    }

                    if (r.day === 7) statusClass += ' day-7';
                %>

                <div class="r-card <%= statusClass %>" role="listitem" aria-label="–î–µ–Ω—å <%= r.day %>: <%= r.description %>">
                    <div class="r-day">–î–µ–Ω—å <%= r.day %></div>
                    <div class="r-icon"><%= r.emoji %></div>
                    <div class="r-val"><%= r.description %></div>
                </div>
            <% }) %>
        </div>

        <div class="action-area">
            <% if (canClaim) { %>
                <button class="btn-claim" onclick="claimReward(this)" aria-label="–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É">
                    –ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£
                </button>
            <% } else { %>
                <button class="btn-claim" disabled aria-label="–ù–∞–≥—Ä–∞–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞">
                    –í–ï–†–ù–ò–°–¨ –ü–û–ó–ñ–ï
                </button>
                <div class="timer-box">
                    –î–æ —Å–ª–µ–¥—É—é—â–µ–π –Ω–∞–≥—Ä–∞–¥—ã: <span id="countdown">--:--:--</span>
                </div>
            <% } %>
        </div>

    </div>

    <%- include('partials/footer') %>

    <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

    <script nonce="<%= nonce %>">
        const nextTime = <%- JSON.stringify(nextClaimTime) %>;
        
        if (nextTime) {
            const timerEl = document.getElementById('countdown');
            
            function updateTimer() {
                const now = new Date().getTime();
                const diff = nextTime - now;

                if (diff <= 0) {
                    location.reload(); 
                    return;
                }

                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                
                if (timerEl) timerEl.innerText = `${h}—á ${m}–º ${s}—Å`;
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        }

        async function claimReward(btn) {
            if(btn.disabled) return;
            const originalText = btn.innerText;
            
            btn.disabled = true;
            btn.innerText = "–û–ë–†–ê–ë–û–¢–ö–ê...";

            try {
                const res = await fetch('/api/daily/claim', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    if (typeof confetti === 'function') {
                        var myCanvas = document.getElementById('confetti-canvas');
                        var myConfetti = confetti.create(myCanvas, { resize: true });
                        myConfetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 },
                            colors: ['#5865F2', '#FFD700', '#FF005C']
                        });
                    }

                    if (typeof Modal !== 'undefined') {
                        await Modal.alert("–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!", data.message, "success");
                    } else {
                        alert(data.message);
                    }
                    
                    location.reload();
                } else {
                    if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", data.error, "error");
                    else alert(data.error);
                    
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>