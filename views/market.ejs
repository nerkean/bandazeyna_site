<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: '–¢–µ—Ä–º–∏–Ω–∞–ª | –ë–∏—Ä–∂–∞' }) %>
    
    <link rel="preload" href="/css/market.css" as="style">
    <link rel="stylesheet" href="/css/market.css">
    
    <style>
        /* –°–∫—Ä—ã—Ç—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div id="canvas-container" aria-hidden="true"></div>

    <div style="margin-top: 100px;"></div>
    
    <div class="market-ticker-wrap">
        <div class="market-ticker">
            <% for(let i=0; i<2; i++) { %>
                <% if (typeof stocks !== 'undefined') { %>
                    <% stocks.forEach(stock => { %>
                        <span class="mt-item">
                            <strong>$<%= stock.ticker %></strong>
                            <span class="mt-val"><%= stock.currentPrice.toFixed(1) %></span>
                            <span class="mt-change <%= stock.lastChange >= 0 ? 'up' : 'down' %>">
                                <i class="fas fa-caret-<%= stock.lastChange >= 0 ? 'up' : 'down' %>"></i>
                                <%= (Math.abs(stock.lastChange) * 100).toFixed(1) %>%
                            </span>
                        </span>
                    <% }) %>
                <% } %>
            <% } %>
        </div>
    </div>

    <main class="market-container">
        
        <header class="market-header">
            <div class="mh-title">
                <h1>Market <span style="color: var(--primary);">Terminal</span></h1>
                <p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏</p>
            </div>

            <button class="m-tab" id="toggleLiteMode" onclick="toggleLiteMode()" style="margin-left: auto;" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å 3D —Ä–µ–∂–∏–º">
                <i class="fas fa-leaf"></i> <span>3D: ON</span>
            </button>
            
            <% if (user) { %>
                <div class="mh-balance">
                    <div class="bal-item">
                        <span class="bal-label">–ë–∞–ª–∞–Ω—Å</span>
                        <span class="bal-val stars" id="userBalanceDisplay"><%= typeof profile !== 'undefined' ? Math.floor(profile.stars).toLocaleString() : 0 %> ‚≠ê</span>
                    </div>
                    <div class="bal-item">
                        <span class="bal-label">–ü–æ—Ä—Ç—Ñ–µ–ª—å</span>
                        <% 
                            const portfolioVal = (typeof portfolio !== 'undefined') ? portfolio.reduce((sum, p) => {
                                const s = stocks.find(x => x.ticker === p.ticker);
                                const price = s ? s.currentPrice : 0;
                                return sum + (p.quantity * price);
                            }, 0) : 0;
                        %>
                        <span class="bal-val shards" style="color: #aaa;"><%= Math.floor(portfolioVal).toLocaleString() %> ‚≠ê</span>
                    </div>
                </div>
            <% } %>
        </header>

        <div class="mobile-tabs">
            <button class="m-tab active" id="btn-tab-list" data-tab="list"><i class="fas fa-list"></i> –ê–∫—Ü–∏–∏</button>
            <button class="m-tab" onclick="switchTab('trade')"><i class="fas fa-chart-line"></i> –¢–µ—Ä–º–∏–Ω–∞–ª</button>
        </div>

        <div class="terminal-grid">
            
            <aside class="stock-sidebar" id="tab-list">
                <h2 class="sr-only">–°–ø–∏—Å–æ–∫ –∞–∫—Ü–∏–π</h2>
                
                <div class="sidebar-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="stockSearch" placeholder="–ù–∞–π—Ç–∏ —Ç–∏–∫–µ—Ä..." aria-label="–ü–æ–∏—Å–∫ –∞–∫—Ü–∏–π">
                </div>

                <div class="stock-list-wrapper">
                    <div class="stock-list" id="stockListContainer">
                        <% if (typeof stocks !== 'undefined' && stocks.length > 0) { %>
                            <% stocks.forEach((stock) => { %>
                                <% 
                                   const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#16a085'];
                                   const charCode = stock.ticker.charCodeAt(0) + stock.ticker.charCodeAt(stock.ticker.length-1);
                                   const color = colors[charCode % colors.length];
                                   const isSystem = ['VOICE', 'TXT', 'PLAYER'].includes(stock.ticker);
                                %>

                                <div class="stock-card" onclick="selectStock('<%= stock.ticker %>', this)" role="button" tabindex="0">
                                    <div class="stock-icon" style="--icon-bg: <%= color %>;">
                                        <%= stock.ticker.substring(0, 2) %>
                                    </div>
                                    <div class="sc-left">
                                        <div class="sc-ticker">
                                            $<%= stock.ticker %>
                                            <% if (isSystem) { %>
                                                <span class="sys-badge official"><i class="fas fa-check-circle"></i></span>
                                            <% } %>
                                        </div>
                                        <div class="sc-name"><%= stock.name %></div>
                                    </div>
                                    <div class="sc-right">
                                        <div class="sc-price"><%= stock.currentPrice.toFixed(2) %></div>
                                        <div class="sc-change <%= stock.lastChange >= 0 ? 'up' : 'down' %>">
                                            <%= stock.lastChange >= 0 ? '+' : '' %><%= (stock.lastChange * 100).toFixed(2) %>%
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="empty-market">–†—ã–Ω–æ–∫ –ø—É—Å—Ç</div>
                        <% } %>
                    </div>
                </div>
            </aside>

            <section class="trade-area" id="tab-trade">
                <div class="chart-card">
                    <div class="chart-top-bar">
                        <div class="ct-info">
                            <h2 id="selectedTicker">---</h2>
                            <span id="selectedName">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ü–∏—é</span>
                        </div>
                        <div class="ct-price">
                            <span id="selectedPrice">0.00</span>
                            <span class="currency">‚≠ê</span>
                        </div>
                    </div>
                    <div id="marketChart" class="chart-box"></div>
                </div>

                <div class="trade-controls" id="tradePanel" style="opacity: 0.5; pointer-events: none;">
                    
                    <h3 class="sr-only">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–æ–π</h3>

                    <div class="user-position">
                        <div class="pos-item"><span>–ù–∞ —Ä—É–∫–∞—Ö:</span><strong id="userShares">0 —à—Ç.</strong></div>
                        <div class="pos-item"><span>–°—Ä–µ–¥–Ω—è—è:</span><strong id="userAvgPrice">0.00</strong></div>
                    </div>

                    <div class="trade-input-section">
                        <div class="input-wrapper">
                            <input type="number" id="tradeAmount" placeholder="–ö–æ–ª-–≤–æ" min="1" value="1" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ü–∏–π">
                            <span class="input-suffix">—à—Ç.</span>
                        </div>
                        <div class="quick-amounts">
                            <button onclick="setAmount(1)">1</button>
                            <button onclick="setAmount(10)">10</button>
                            <button onclick="setAmount(100)">100</button>
                            <button class="max-btn" onclick="setMaxAmount()">MAX</button>
                        </div>
                    </div>

                    <div class="trade-right-col">
                        <div class="trade-summary"><span>–ò—Ç–æ–≥–æ:</span><span id="totalPrice">0 ‚≠ê</span></div>
                        <div class="trade-buttons">
                            <button class="t-btn buy" onclick="tradeStock('BUY')">–ö–£–ü–ò–¢–¨</button>
                            <button class="t-btn sell" onclick="tradeStock('SELL')">–ü–†–û–î–ê–¢–¨</button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <%- include('partials/footer') %>

    <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/apexcharts" defer></script>
    <script nonce="<%= nonce %>" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
    <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js" defer></script>
    <script nonce="<%= nonce %>" src="/socket.io/socket.io.js"></script>

    <script nonce="<%= nonce %>">
        // ... (–¢–≤–æ–π JS –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —è –Ω–µ –º–µ–Ω—è–ª) ...
        const socket = io();

        socket.on('market_update', (data) => {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏—Ä–∂–∏!', data);
            
            const { updates } = data;
            
            updates.forEach(update => {
                const cards = document.querySelectorAll('.stock-card');
                cards.forEach(card => {
                    if (card.innerText.includes(update.ticker)) {
                        const priceEl = card.querySelector('.sc-price');
                        if (priceEl) priceEl.innerText = update.price.toFixed(2);
                        
                        const changeEl = card.querySelector('.sc-change');
                        if (changeEl) {
                            const sign = update.change >= 0 ? '+' : '';
                            changeEl.innerText = `${sign}${(update.change * 100).toFixed(2)}%`;
                            changeEl.className = `sc-change ${update.change >= 0 ? 'up' : 'down'}`;
                        }
                        
                        card.style.transition = 'background 0.3s';
                        card.style.backgroundColor = update.change >= 0 ? 'rgba(46, 204, 113, 0.2)' : 'rgba(231, 76, 60, 0.2)';
                        setTimeout(() => card.style.backgroundColor = '', 500);
                    }
                });

                if (currentStock && currentStock.ticker === update.ticker) {
                    document.getElementById('selectedPrice').innerText = update.price.toFixed(2);
                    currentStock.currentPrice = update.price; 
                    updateCalc(); 
                }
            });
        });
        
        const allStocks = JSON.parse('<%- JSON.stringify(stocks).replace(/'/g, "\\'").replace(/\\/g, "\\\\") %>');
        const userPortfolio = <%- typeof portfolio !== 'undefined' ? JSON.stringify(portfolio) : '[]' %>;
        
        function getCurrentBalance() {
            const text = document.getElementById('userBalanceDisplay').innerText;
            return parseInt(text.replace(/[^0-9]/g, '')) || 0;
        }

        let chartInstance = null;
        let currentStock = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('stockSearch').addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                document.querySelectorAll('.stock-card').forEach(card => {
                    const text = card.innerText.toLowerCase();
                    card.style.display = text.includes(val) ? 'flex' : 'none';
                });
            });

            document.getElementById('tradeAmount').addEventListener('input', updateCalc);

            document.getElementById('btn-tab-list').addEventListener('click', () => switchTab('list'));

            if(allStocks.length > 0) {
                if(window.innerWidth > 900) selectStock(allStocks[0].ticker, document.querySelector('.stock-card'));
                else switchTab('list');
            }

            init3D();
        });

        function setAmount(n) { document.getElementById('tradeAmount').value = n; updateCalc(); }
        
        function setMaxAmount() {
            if(!currentStock) return;
            const balance = getCurrentBalance();
            const maxBuy = Math.floor(balance / currentStock.currentPrice);
            const userPos = userPortfolio.find(p => p.ticker === currentStock.ticker);
            const maxSell = userPos ? userPos.quantity : 0;
            document.getElementById('tradeAmount').value = maxBuy > 0 ? maxBuy : (maxSell > 0 ? maxSell : 1);
            updateCalc();
        }

        function updateCalc() {
            if(!currentStock) return;
            const qty = parseInt(document.getElementById('tradeAmount').value) || 0;
            const total = Math.floor(qty * currentStock.currentPrice);
            document.getElementById('totalPrice').innerText = total.toLocaleString() + ' ‚≠ê';
        }

        function switchTab(tab) {
            const list = document.getElementById('tab-list');
            const trade = document.getElementById('tab-trade');
            const btns = document.querySelectorAll('.m-tab');
            btns.forEach(b => b.classList.remove('active'));
            
            if (tab === 'list') {
                list.classList.add('active'); trade.classList.remove('active'); btns[0].classList.add('active');
            } else {
                list.classList.remove('active'); trade.classList.add('active'); btns[1].classList.add('active');
            }
        }

        function selectStock(ticker, el) {
            document.querySelectorAll('.stock-card').forEach(c => c.classList.remove('active'));
            if(el) el.classList.add('active');

            const stock = allStocks.find(s => s.ticker === ticker);
            if(!stock) return;
            currentStock = stock;

            const isSystem = ['VOICE', 'TXT', 'PLAYER'].includes(ticker);
            const badgeHtml = isSystem ? `<span class="sys-badge official" title="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ"><i class="fas fa-check-circle"></i></span>` : '';
            
            document.getElementById('selectedTicker').innerHTML = `$${stock.ticker} ${badgeHtml}`;
            document.getElementById('selectedName').innerText = stock.name;
            
            const pEl = document.getElementById('selectedPrice');
            pEl.innerText = stock.currentPrice.toFixed(2);
            pEl.className = stock.lastChange >= 0 ? 'up-text' : 'down-text';

            document.getElementById('tradePanel').style.opacity = '1';
            document.getElementById('tradePanel').style.pointerEvents = 'all';

            const pos = userPortfolio.find(p => p.ticker === ticker);
            if (pos) {
                document.getElementById('userShares').innerText = pos.quantity + ' —à—Ç.';
                const profit = stock.currentPrice - pos.avgBuyPrice;
                const profitPercent = ((profit / pos.avgBuyPrice) * 100).toFixed(1);
                const sign = profit >= 0 ? '+' : '';
                const color = profit >= 0 ? '#2ecc71' : '#e74c3c';
                document.getElementById('userAvgPrice').innerHTML = `${pos.avgBuyPrice.toFixed(1)} <small style="color:${color}">(${sign}${profitPercent}%)</small>`;
            } else {
                document.getElementById('userShares').innerText = '0 —à—Ç.';
                document.getElementById('userAvgPrice').innerText = '---';
            }

            if(window.innerWidth <= 900) switchTab('trade');
            updateCalc();
            
            if (typeof ApexCharts !== 'undefined') renderChart(stock);
        }

        function renderChart(stock) {
            const prices = stock.priceHistory.map(h => h.price);
            const dates = stock.priceHistory.map(h => new Date(h.date).getTime());
            const color = stock.lastChange >= 0 ? '#2ecc71' : '#ef4444';

            if (chartInstance) {
                chartInstance.updateOptions({ colors: [color], fill: { gradient: { colorStops: [{ offset: 0, color: color, opacity: 0.4 }, { offset: 100, color: color, opacity: 0 }] } } });
                chartInstance.updateSeries([{ data: prices }]);
                chartInstance.updateOptions({ xaxis: { categories: dates } });
            } else {
                const options = {
                    series: [{ name: '–¶–µ–Ω–∞', data: prices }],
                    chart: { type: 'area', height: 350, background: 'transparent', animations: { enabled: true }, toolbar: { show: false }, zoom: { enabled: false } },
                    theme: { mode: 'dark' },
                    stroke: { curve: 'monotoneCubic', width: 3, colors: [color] },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100], colorStops: [{ offset: 0, color: color, opacity: 0.4 }, { offset: 100, color: color, opacity: 0 }] } },
                    dataLabels: { enabled: false },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4 },
                    xaxis: { categories: dates, type: 'datetime', labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false }, tooltip: { enabled: false } },
                    yaxis: { opposite: true, labels: { style: { colors: '#b3b3b3', fontFamily: 'JetBrains Mono' }, formatter: (val) => val.toFixed(1) } },
                    tooltip: { theme: 'dark', x: { format: 'dd MMM HH:mm' }, y: { formatter: (val) => val.toFixed(2) + " ‚≠ê" } }
                };
                chartInstance = new ApexCharts(document.querySelector("#marketChart"), options);
                chartInstance.render();
            }
        }

        async function tradeStock(action) {
            const amount = document.getElementById('tradeAmount').value;
            const ticker = currentStock.ticker;
            const totalPrice = (currentStock.currentPrice * amount).toFixed(0);
            const actName = action === 'BUY' ? '–ø–æ–∫—É–ø–∫—É' : '–ø—Ä–æ–¥–∞–∂—É';

            if (typeof Modal !== 'undefined') {
                const ok = await Modal.confirm("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", `–°–æ–≤–µ—Ä—à–∏—Ç—å ${actName} <b>${amount}</b> –∞–∫—Ü–∏–π <b>${ticker}</b> –∑–∞ <b>${totalPrice}</b> ‚≠ê?`);
                if(!ok) return;
            } else if(!confirm(`–°–æ–≤–µ—Ä—à–∏—Ç—å ${actName}?`)) return;

            try {
                const res = await fetch('/api/trade', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ticker, amount: parseInt(amount), action }) });
                const data = await res.json();
                if(data.success) {
                    if(typeof Modal !== 'undefined') await Modal.alert("–£—Å–ø–µ—à–Ω–æ", data.message, "success");
                    else alert(data.message);
                    location.reload();
                } else {
                    if(typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", data.error, "error");
                    else alert(data.error);
                }
            } catch(e) { console.error(e); }
        }

        function init3D() {
        const isLite = localStorage.getItem('liteMode') === 'true';
            if (isLite) {
                console.log('üöÄ Lite Mode: 3D Animation skipped');
                document.getElementById('toggleLiteMode').innerHTML = '<i class="fas fa-leaf"></i> <span>3D: OFF</span>';
                document.getElementById('toggleLiteMode').style.opacity = '0.5';
                return;
            }

            if (typeof THREE === 'undefined' || typeof THREE.GLTFLoader === 'undefined') {
                setTimeout(init3D, 500); return; 
            }
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffd700, 3);
            dirLight.position.set(5, 5, 7);
            scene.add(dirLight);

            const coins = [];
            const loader = new THREE.GLTFLoader();
            
            loader.load('/assets/models/coin.glb', function (gltf) {
                const originalCoin = gltf.scene;
                const isMobile = window.innerWidth < 768;
                const count = isMobile ? 8 : 20;

                for (let i = 0; i < count; i++) {
                    const coin = originalCoin.clone();
                    const x = (Math.random() - 0.5) * 25;
                    const y = (Math.random() - 0.5) * 15;
                    const z = -Math.random() * 10;
                    const scale = Math.random() * 1.0 + 0.5;
                    
                    coin.position.set(x, y, z);
                    coin.scale.set(scale, scale, scale);
                    coin.rotation.x = Math.PI / 2;
                    coin.userData = {
                        rotSpeedX: (Math.random() - 0.5) * 0.02,
                        rotSpeedZ: (Math.random() - 0.5) * 0.03,
                        floatOffset: Math.random() * Math.PI * 2
                    };
                    scene.add(coin);
                    coins.push(coin);
                }
            }, undefined, (err) => console.log('3D Error (Ignore if no model):', err));

            function animate() {
                requestAnimationFrame(animate);
                coins.forEach(coin => {
                    coin.rotation.z += coin.userData.rotSpeedZ;
                    coin.rotation.x += coin.userData.rotSpeedX;
                    coin.position.y += Math.sin(Date.now() * 0.001 + coin.userData.floatOffset) * 0.002;
                });
                renderer.render(scene, camera);
            }
            animate();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function toggleLiteMode() {
            const current = localStorage.getItem('liteMode') === 'true';
            const newState = !current;
            localStorage.setItem('liteMode', newState);
            
            if (newState) {
                alert('–≠–∫–æ–Ω–æ–º–∏—á–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω. 3D –æ—Ç–∫–ª—é—á–µ–Ω–æ.');
                location.reload(); 
            } else {
                alert('3D —ç—Ñ—Ñ–µ–∫—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã!');
                location.reload();
            }
        }
    </script>
</body>
</html>