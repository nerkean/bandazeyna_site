<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: 'Апелляции (Admin)' }) %>
    <style>
        body {
            background-color: #050505;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
        }
        
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 120px 20px 60px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 40px;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .badge-count {
            background: #e74c3c;
            color: white;
            font-size: 1rem;
            padding: 5px 12px;
            border-radius: 50px;
            vertical-align: middle;
            -webkit-text-fill-color: initial;
        }

        .appeal-card {
            background: #111;
            border: 1px solid #333;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .appeal-card:hover {
            border-color: #555;
        }

        /* --- ШАПКА КАРТОЧКИ --- */
        .ac-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 1px solid #222;
            margin-bottom: 20px;
        }

        .ac-avatar-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5865F2, #404EED);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .ac-user-info h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #fff;
        }

        .ac-user-info span {
            font-size: 0.85rem;
            color: #888;
            font-family: monospace;
            cursor: pointer;
            transition: color 0.2s;
        }
        .ac-user-info span:hover { color: #fff; }

        .ac-date {
            margin-left: auto;
            color: #666;
            font-size: 0.9rem;
        }

        /* --- БЛОКИ КОНТЕНТА --- */
        .section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .official-reason {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            color: #e74c3c;
            margin-bottom: 25px;
            font-weight: 600;
            font-family: monospace;
        }

        .user-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .user-box {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }

        .user-text {
            color: #ddd;
            line-height: 1.5;
            font-size: 0.95rem;
            white-space: pre-wrap; /* Сохраняет переносы строк */
        }

        /* --- КНОПКИ --- */
        .ac-actions {
            display: flex;
            gap: 15px;
            padding-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-approve { background: #27ae60; color: white; }
        .btn-approve:hover { background: #2ecc71; transform: translateY(-2px); }

        .btn-reject { background: #c0392b; color: white; }
        .btn-reject:hover { background: #e74c3c; transform: translateY(-2px); }

        @media (max-width: 768px) {
            .user-content-grid { grid-template-columns: 1fr; }
            .ac-header { flex-wrap: wrap; }
            .ac-date { width: 100%; margin: 5px 0 0 65px; }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    
    <div class="admin-container">
        <h1>
            <i class="fas fa-gavel"></i> Апелляции 
            <% if (appeals.length > 0) { %>
                <span class="badge-count"><%= appeals.length %></span>
            <% } %>
        </h1>
        
        <% if (appeals.length === 0) { %>
            <div style="text-align: center; padding: 80px; color: #444;">
                <i class="fas fa-check-circle" style="font-size: 5rem; margin-bottom: 20px; color: #2ecc71; opacity: 0.5;"></i>
                <h2>Все чисто!</h2>
                <p>Нет новых заявок на разбан.</p>
            </div>
        <% } %>

        <% appeals.forEach(appeal => { 
            let userReason = "Не указано (Старый формат)";
            let userAppeal = appeal.appealText;

            if (appeal.appealText.includes('[Причина бана со слов игрока]:')) {
                const parts = appeal.appealText.split('\n\n[Оправдание]:');
                userReason = parts[0].replace('[Причина бана со слов игрока]:', '').trim();
                userAppeal = parts[1] ? parts[1].trim() : "";
            }
        %>
            <div class="appeal-card" id="app-<%= appeal._id %>">
                
                <div class="ac-header">
                    <div class="ac-avatar-placeholder">
                        <%= appeal.username.charAt(0).toUpperCase() %>
                    </div>
                    
                    <div class="ac-user-info">
                        <h3><%= appeal.username %></h3>
                        <span title="Нажми, чтобы скопировать" onclick="copyId('<%= appeal.userId %>')">
                            ID: <%= appeal.userId %> <i class="far fa-copy"></i>
                        </span>
                    </div>

                    <div class="ac-date">
                        <i class="far fa-clock"></i> <%= new Date(appeal.createdAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }) %>
                    </div>
                </div>

                <div class="section-label">Официальная причина (из профиля)</div>
                <div class="official-reason">
                    <%= appeal.banReason || 'Не указана' %>
                </div>

                <div class="user-content-grid">
                    <div class="user-box">
                        <div class="section-label" style="color: #aaa;">Версия игрока (За что бан?)</div>
                        <div class="user-text"><%= userReason %></div>
                    </div>
                    <div class="user-box">
                        <div class="section-label" style="color: #FFD700;">Почему разбанить?</div>
                        <div class="user-text"><%= userAppeal %></div>
                    </div>
                </div>

                <div class="ac-actions">
                    <button class="btn btn-approve" onclick="decide('<%= appeal._id %>', 'approve')">
                        <i class="fas fa-unlock"></i> Разбанить
                    </button>
                    <button class="btn btn-reject" onclick="decide('<%= appeal._id %>', 'reject')">
                        <i class="fas fa-ban"></i> Отказать
                    </button>
                </div>

            </div>
        <% }) %>
    </div>

    <script nonce="<%= nonce %>">
        function copyId(id) {
            navigator.clipboard.writeText(id);
            alert('ID скопирован: ' + id);
        }

        async function decide(id, action) {
            const card = document.getElementById('app-' + id);
            
            if (!confirm(action === 'approve' ? 'Снять блокировку с этого пользователя?' : 'Отклонить заявку? (Бан останется)')) return;

            card.style.opacity = '0.5';
            card.style.pointerEvents = 'none';

            try {
                const res = await fetch('/api/admin/appeal/decide', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appealId: id, action })
                });
                const data = await res.json();
                
                if (data.success) {
                    card.style.transform = 'translateX(100px)';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 300);

                    const badge = document.querySelector('.badge-count');
                    if (badge) {
                        const count = parseInt(badge.innerText) - 1;
                        if (count <= 0) badge.remove();
                        else badge.innerText = count;
                    }
                } else {
                    alert('Ошибка: ' + data.error);
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
            } catch (e) { 
                alert('Ошибка сети');
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
            }
        }
    </script>
</body>
</html>