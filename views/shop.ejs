<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: '–ú–∞–≥–∞–∑–∏–Ω | –î–∞—á–∞ –ó–µ–π–Ω–∞' }) %>
    <link rel="stylesheet" href="/css/shop.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="shop-wrapper">
        <header class="shop-header">
            <h1><span class="text-gradient">Marketplace</span></h1>
            <p>–ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π –≤ —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.</p>
            
            <div class="shop-tabs-container">
                <div class="shop-tabs">
                    <button class="tab-btn active" onclick="filterShop('all', this)"><i class="fas fa-th-large"></i> –í—Å–µ</button>
                    <button class="tab-btn" onclick="filterShop('–õ—É—Ç–±–æ–∫—Å', this)"><i class="fas fa-box-open"></i> –õ—É—Ç–±–æ–∫—Å—ã</button>
                    <button class="tab-btn" onclick="filterShop('–†–∞—Å—Ö–æ–¥–Ω–∏–∫', this)"><i class="fas fa-bolt"></i> –ë—É—Å—Ç—ã</button>
                    <button class="tab-btn" onclick="filterShop('–£–∫—Ä–∞—à–µ–Ω–∏–µ', this)"><i class="fas fa-paint-brush"></i> –ö–æ—Å–º–µ—Ç–∏–∫–∞</button>
                    <button class="tab-btn btn-premium-tab" onclick="filterShop('–ü—Ä–µ–º–∏—É–ºView', this)"><i class="fas fa-gem"></i> –ü—Ä–µ–º–∏—É–º</button>
                </div>
            </div>
        </header>

        <div class="items-grid" id="itemsGrid">
            <% items.forEach((item, index) => { 
                if (item.category.includes('–ü—Ä–µ–º–∏—É–º')) return;

                let rarity = 'common';
                if (item.price.stars >= 5000 || item.price.shards >= 50) rarity = 'legendary';
                else if (item.price.stars >= 1000 || item.price.shards >= 20) rarity = 'epic';
                else if (item.price.stars >= 300 || item.price.shards >= 5) rarity = 'rare';
            %>
                <div class="item-card <%= rarity %>" 
                     onclick="openPreview(this)"
                     data-id="<%= item.itemId %>"
                     data-name="<%= item.name %>"
                     data-desc="<%= item.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.' %>"
                     data-type="<%= item.category %>"
                     data-rarity="<%= rarity %>"
                     data-image="<%= item.imageUrl_web || '' %>"
                     data-emoji="<%= item.emoji || 'üì¶' %>"
                     data-stars="<%= item.price.stars || 0 %>"
                     data-shards="<%= item.price.shards || 0 %>"
                     data-aos="fade-up" 
                     data-aos-delay="<%= index * 50 %>">
                    
                    <% if (rarity === 'legendary') { %>
                        <div class="rarity-badge legendary">LEGENDARY</div>
                    <% } %>

                    <div class="item-visual">
                        <div class="item-glow"></div>
                        <% if (item.imageUrl_web) { %>
                            <img src="<%= item.imageUrl_web %>" class="item-img" alt="<%= item.name %>">
                        <% } else { %>
                            <div class="item-emoji"><%= item.emoji || 'üì¶' %></div>
                        <% } %>
                    </div>
                    
                    <div class="item-content">
                        <div class="item-header">
                            <h3><%= item.name %></h3>
                            <span class="item-type"><%= item.category %></span>
                        </div>
                        
                        <div class="item-footer">
                            <div class="price-tag">
                                <% if (item.price.stars > 0) { %>
                                    <span class="cost gold"><%= item.price.stars.toLocaleString() %> ‚≠ê</span>
                                <% } %>
                                <% if (item.price.shards > 0) { %>
                                    <span class="cost shard"><%= item.price.shards %> ‚ú®</span>
                                <% } %>
                            </div>
                            <span class="tap-hint">–ù–∞–∂–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</span>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>

        <div id="premiumDashboard" style="display: none;" data-aos="zoom-in">
            
            <div class="premium-status-card <%= profile.premiumType ? 'is-active' : 'is-inactive' %>">
                <div class="psc-content">
                    <h2>–í–∞—à –ü—Ä–µ–º–∏—É–º –°—Ç–∞—Ç—É—Å</h2>
                    <% if (profile.premiumType) { %>
                        <div class="status-badge active">
                            <i class="fas fa-check-circle"></i> –ê–ö–¢–ò–í–ï–ù
                        </div>
                        <p class="status-desc">
                            –¢–∏–ø: <strong style="color: #fff; text-transform: capitalize;"><%= profile.premiumType === 'permanent' ? '–ù–∞–≤—Å–µ–≥–¥–∞' : '–í—Ä–µ–º–µ–Ω–Ω—ã–π' %></strong>
                            <% if (profile.premiumType === 'temporary' && profile.premiumRoleExpiresAt) { %>
                                <br>–ò—Å—Ç–µ–∫–∞–µ—Ç: <span><%= new Date(profile.premiumRoleExpiresAt).toLocaleDateString() %></span>
                            <% } %>
                        </p>
                    <% } else { %>
                        <div class="status-badge inactive">
                            <i class="fas fa-times-circle"></i> –ù–ï –ê–ö–¢–ò–í–ï–ù
                        </div>
                        <p class="status-desc">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞.</p>
                    <% } %>
                </div>
                <div class="psc-visual">
                    <i class="fas fa-gem"></i>
                </div>
            </div>

            <div class="premium-benefits">
                <div class="benefit-item">
                    <div class="ben-icon gold"><i class="fas fa-ticket-alt"></i></div>
                    <div class="ben-text">
                        <h4>–ó–æ–ª–æ—Ç–æ–π –±–∏–ª–µ—Ç</h4>
                        <p>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —à–∞–Ω—Å –Ω–∞ –ø–æ–±–µ–¥—É –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="ben-icon star"><i class="fas fa-star"></i></div>
                    <div class="ben-text">
                        <h4>+10% –∫ –ó–≤–µ–∑–¥–∞–º</h4>
                        <p>–ü–∞—Å—Å–∏–≤–Ω—ã–π –±—É—Å—Ç –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –≤–∞–ª—é—Ç—ã.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="ben-icon purple"><i class="fas fa-paint-brush"></i></div>
                    <div class="ben-text">
                        <h4>–ö–æ—Å–º–µ—Ç–∏–∫–∞</h4>
                        <p>–î–æ—Å—Ç—É–ø –∫ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–º —Ä–∞–º–∫–∞–º –∏ —Ñ–æ–Ω–∞–º.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="ben-icon red"><i class="fas fa-shield-alt"></i></div>
                    <div class="ben-text">
                        <h4>–ú—è–≥–∫–∏–µ –Ω–∞–∫–∞–∑–∞–Ω–∏—è</h4>
                        <p>–°—Ä–æ–∫ –º—É—Ç–∞ –æ—Ç –±–æ—Ç–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ 25%.</p>
                    </div>
                </div>
            </div>

            <div class="premium-plans">
                <div class="plan-card">
                    <div class="plan-header">
                        <h3>14 –î–Ω–µ–π</h3>
                        <span class="plan-cost">6 ‚ú®</span>
                    </div>
                    <ul class="plan-features">
                        <li><i class="fas fa-check"></i> –í—Å–µ –±–æ–Ω—É—Å—ã</li>
                        <li><i class="fas fa-check"></i> –¢–µ—Å—Ç-–¥—Ä–∞–π–≤</li>
                    </ul>
                    <button class="btn-plan" onclick="buyItem('premium_14d', '–ü—Ä–µ–º–∏—É–º (14 –¥–Ω–µ–π)')">–ö—É–ø–∏—Ç—å</button>
                </div>

                <div class="plan-card featured">
                    <div class="best-value">POPULAR</div>
                    <div class="plan-header">
                        <h3>30 –î–Ω–µ–π</h3>
                        <span class="plan-cost">10 ‚ú®</span>
                    </div>
                    <ul class="plan-features">
                        <li><i class="fas fa-check"></i> –í—Å–µ –±–æ–Ω—É—Å—ã</li>
                        <li><i class="fas fa-check"></i> –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä</li>
                    </ul>
                    <button class="btn-plan" onclick="buyItem('premium_30d', '–ü—Ä–µ–º–∏—É–º (30 –¥–Ω–µ–π)')">–ö—É–ø–∏—Ç—å</button>
                </div>

                <div class="plan-card legendary">
                    <div class="plan-header">
                        <h3>–ù–∞–≤—Å–µ–≥–¥–∞</h3>
                        <span class="plan-cost">70 ‚ú®</span>
                    </div>
                    <ul class="plan-features">
                        <li><i class="fas fa-check"></i> –í—Å–µ –±–æ–Ω—É—Å—ã</li>
                        <li><i class="fas fa-check"></i> –ü–ª–∞—Ç–∏ –æ–¥–∏–Ω —Ä–∞–∑</li>
                        <li><i class="fas fa-crown"></i> –í–µ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å</li>
                    </ul>
                    <button class="btn-plan" onclick="buyItem('premium_perm', '–ü—Ä–µ–º–∏—É–º (–ù–∞–≤—Å–µ–≥–¥–∞)')">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div class="preview-overlay" id="previewModal" onclick="if(event.target === this) closePreview()">
        <div class="preview-box">
            <button class="close-btn" onclick="closePreview()"><i class="fas fa-times"></i></button>
            <div class="preview-left">
                <div class="preview-visual-container" id="pVisualContainer"></div>
            </div>
            <div class="preview-right">
                <div class="p-header">
                    <span class="p-rarity" id="pRarity">COMMON</span>
                    <h2 id="pName">Item Name</h2>
                    <span class="p-type" id="pType">Category</span>
                </div>
                <div class="p-body">
                    <p id="pDesc">Description goes here...</p>
                </div>
                <div class="p-footer">
                    <div class="p-price" id="pPrice"></div>
                    <button class="btn-buy-big" id="pBuyBtn">–ö–£–ü–ò–¢–¨ –°–ï–ô–ß–ê–°</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
        function filterShop(category, btnElement) {
            const itemsGrid = document.getElementById('itemsGrid');
            const premiumDash = document.getElementById('premiumDashboard');
            const buttons = document.querySelectorAll('.tab-btn');

            if (btnElement) {
                buttons.forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            if (category === '–ü—Ä–µ–º–∏—É–ºView') {
                itemsGrid.style.display = 'none';
                premiumDash.style.display = 'block';
                if (typeof AOS !== 'undefined') setTimeout(() => AOS.refresh(), 100);
                return;
            } else {
                premiumDash.style.display = 'none';
                itemsGrid.style.display = 'grid';
            }

            const cards = document.querySelectorAll('.item-card');
            cards.forEach(card => {
                const rawCat = card.getAttribute('data-category') || '';
                const cat = rawCat.trim();

                let isMatch = false;
                if (category === 'all') isMatch = true;
                else if (cat.includes(category)) isMatch = true;

                if (isMatch) {
                    card.style.display = ''; 
                    card.classList.remove('aos-animate');
                    setTimeout(() => card.classList.add('aos-animate'), 50);
                } else {
                    card.style.display = 'none';
                }
            });

            if (typeof AOS !== 'undefined') setTimeout(() => AOS.refresh(), 100);
        }

        const previewModal = document.getElementById('previewModal');
        
        function openPreview(card) {
            const id = card.getAttribute('data-id');
            const name = card.getAttribute('data-name');
            const desc = card.getAttribute('data-desc');
            const type = card.getAttribute('data-type');
            const rarity = card.getAttribute('data-rarity');
            const img = card.getAttribute('data-image');
            const emoji = card.getAttribute('data-emoji');
            const stars = parseInt(card.getAttribute('data-stars'));
            const shards = parseInt(card.getAttribute('data-shards'));

            document.getElementById('pName').innerText = name;
            document.getElementById('pDesc').innerText = desc;
            document.getElementById('pType').innerText = type;
            
            const rarityEl = document.getElementById('pRarity');
            rarityEl.innerText = rarity.toUpperCase();
            rarityEl.className = `p-rarity ${rarity}`;

            const visualContainer = document.getElementById('pVisualContainer');
            visualContainer.className = `preview-visual-container ${rarity}`;
            if (img) {
                visualContainer.innerHTML = `<img src="${img}" class="p-img">`;
            } else {
                visualContainer.innerHTML = `<div class="p-emoji">${emoji}</div>`;
            }

            const priceContainer = document.getElementById('pPrice');
            priceContainer.innerHTML = '';
            if (stars > 0) priceContainer.innerHTML += `<span class="p-cost gold">${stars.toLocaleString()} ‚≠ê</span>`;
            if (shards > 0) priceContainer.innerHTML += `<span class="p-cost shard">${shards} ‚ú®</span>`;

            const buyBtn = document.getElementById('pBuyBtn');
            buyBtn.onclick = () => buyItem(id, name);

            previewModal.classList.add('active');
        }

        function closePreview() {
            previewModal.classList.remove('active');
        }

        async function buyItem(itemId, itemName) {
            closePreview(); 

            let qty = 1;
            if (!itemId.startsWith('premium_')) {
                 const input = prompt(`–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è "${itemName}":`, "1");
                 if (input === null) return;
                 qty = parseInt(input);
                 if (!qty || qty < 1) {
                     if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ", "error");
                     else alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ");
                     return;
                 }
            }

            if (typeof Modal !== 'undefined') {
                const confirmed = await Modal.confirm("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", `–ö—É–ø–∏—Ç—å <b>${qty > 1 ? qty + 'x ' : ''}${itemName}</b>?`);
                if (!confirmed) return;
            } else {
                if(!confirm(`–ö—É–ø–∏—Ç—å ${itemName}?`)) return;
            }

            try {
                const res = await fetch('/api/shop/buy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ itemId, quantity: qty })
                });
                const result = await res.json();

                if (result.success) {
                    if (typeof Modal !== 'undefined') await Modal.alert("–£—Å–ø–µ—à–Ω–æ!", result.message, "success");
                    else alert(result.message);
                    location.reload(); 
                } else {
                    if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", result.error, "error");
                    else alert(result.error);
                }
            } catch (e) {
                if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
                else alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
            }
        }
    </script>
    
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>AOS.init();</script>
</body>
</html>