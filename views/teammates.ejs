<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/css/teammates.css">
    <%- include('partials/head', { title: '–ü–æ–∏—Å–∫ –¢–∏–º–º–µ–π—Ç–æ–≤' }) %>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 120px 20px 80px;">
        
        <div class="page-header">
    <div class="header-text">
        <div style="display: flex; align-items: center; gap: 15px;">
            <h1>LFG <span style="color: #2ecc71;">Board</span></h1>
            <button class="help-btn" onclick="showLfgRules()" title="–ü—Ä–∞–≤–∏–ª–∞ LFG">
                <i class="fas fa-question"></i>
            </button>
        </div>
        <p style="color: #888; margin-top: 5px;">
            –ó–∞—è–≤–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
        </p>
    </div>

            <% if (user) { %>
                <button class="create-btn-floating" onclick="openLfgModal()">
                    <i class="fas fa-plus-circle"></i> 
                    <%= myRequest ? '–ú–æ—è –∑–∞—è–≤–∫–∞' : '–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ' %>
                </button>
            <% } else { %>
                <a href="/auth/discord" class="create-btn-floating" style="background: #5865F2; text-decoration: none;">
                    <i class="fab fa-discord"></i> –í–æ–π—Ç–∏
                </a>
            <% } %>
        </div>

        <div class="filter-container">
            <button class="filter-btn active" onclick="setFilter('ALL', this)">–í—Å–µ</button>
            <button class="filter-btn" onclick="setFilter('MACRO', this)">ü§ñ –ú–∞–∫—Ä–æ</button>
            <button class="filter-btn" onclick="setFilter('FARM', this)">üêù –§–∞—Ä–º</button>
            <button class="filter-btn" onclick="setFilter('PUFFSHROOMS', this)">üçÑ Puffs</button>
            <button class="filter-btn" onclick="setFilter('ROBO', this)">ü§ñ Robo</button>
            <button class="filter-btn" onclick="setFilter('OTHER', this)">‚ùì –î—Ä—É–≥–æ–µ</button>
        </div>

        <div class="grid-container" id="cardsContainer">
            <% requests.forEach((req) => { %>
                <div class="tm-card hive-<%= req.hiveColor %>" data-type="<%= req.activityType %>">
                    
                    <div class="card-top">
                        <div class="user-wrap">
                            <img src="<%= req.avatar %>" class="tm-avatar" alt="Ava" onerror="this.src='/assets/img/avatars/default_avatar.png'">
                            <div class="user-details">
                                <h4><%= req.username %></h4>
                                <span class="hive-tag" style="color: <%= req.hiveColor === 'BLUE' ? '#3498db' : req.hiveColor === 'RED' ? '#e74c3c' : req.hiveColor === 'WHITE' ? '#ecf0f1' : '#9b59b6' %>">
                                    <%= req.hiveColor %> Hive
                                </span>
                            </div>
                        </div>

                        <div class="activity-badge act-<%= req.activityType %>">
                            <% if(req.activityType === 'MACRO') { %> <i class="fas fa-robot"></i> <span>Macro</span> <% } %>
                            <% if(req.activityType === 'FARM') { %> <i class="fas fa-leaf"></i> <span>Farm</span> <% } %>
                            <% if(req.activityType === 'STICKERS') { %> <i class="fas fa-sticky-note"></i> <span>Trade</span> <% } %>
                            <% if(req.activityType === 'PUFFSHROOMS') { %> <i class="fas fa-cloud"></i> <span>Puffs</span> <% } %>
                            <% if(req.activityType === 'ROBO') { %> <i class="fas fa-gamepad"></i> <span>Robo</span> <% } %>
                            <% if(req.activityType === 'OTHER') { %> <i class="fas fa-question-circle"></i> <span>–î—Ä—É–≥–æ–µ</span> <% } %>
                        </div>
                    </div>

                    <div class="tm-desc">
                        <%= req.description %>
                    </div>

                    <div class="card-footer">
                        <button class="discord-btn" onclick="copyDiscord('<%= req.username %>')">
                            <i class="fab fa-discord"></i> Copy Nick
                        </button>
                        
                        <span class="time-ago">
                            <% 
                                const diff = Math.floor((Date.now() - new Date(req.createdAt)) / 60000);
                            %>
                            <%= diff < 1 ? '–¢–æ–ª—å–∫–æ —á—Ç–æ' : diff + ' –º–∏–Ω. –Ω–∞–∑–∞–¥' %>
                        </span>
                    </div>
                </div>
            <% }) %>
        </div>

        <div id="emptyState" style="text-align: center; color: #555; margin-top: 50px; display: none;">
            <i class="far fa-clock" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
            <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç.<br>–°–æ–∑–¥–∞–π —Å–≤–æ—é!</p>
        </div>

        <div class="pagination-wrapper" id="paginationControls">
            </div>
    </div>

    <% if (user) { %>
    <div class="modal-overlay" id="lfgModalOverlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2><%= myRequest ? '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É' : '‚ú® –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞' %></h2>
                <button class="modal-close" onclick="closeLfgModal()">&times;</button>
            </div>
            
            <form id="lfgForm">
                <div class="form-group">
                    <label class="form-label">–¶–µ–ª—å –ø–æ–∏—Å–∫–∞</label>
                    <select name="activityType" class="custom-input" required>
                        <option value="MACRO" <%= myRequest?.activityType === 'MACRO' ? 'selected' : '' %>>ü§ñ –ú–∞–∫—Ä–æ (Macro)</option>
                        <option value="FARM" <%= myRequest?.activityType === 'FARM' ? 'selected' : '' %>>üêù –§–∞—Ä–º –ú—ë–¥–∞</option>
                        <option value="PUFFSHROOMS" <%= myRequest?.activityType === 'PUFFSHROOMS' ? 'selected' : '' %>>üçÑ Puffshrooms</option>
                        <option value="ROBO" <%= myRequest?.activityType === 'ROBO' ? 'selected' : '' %>>ü§ñ Robo Challenge</option>
                        <option value="OTHER" <%= myRequest?.activityType === 'OTHER' ? 'selected' : '' %>>‚ùì –î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–¢–≤–æ–π –£–ª–µ–π</label>
                    <select name="hiveColor" class="custom-input" required>
                        <option value="BLUE" <%= myRequest?.hiveColor === 'BLUE' ? 'selected' : '' %>>üîµ –°–∏–Ω–∏–π (Blue)</option>
                        <option value="RED" <%= myRequest?.hiveColor === 'RED' ? 'selected' : '' %>>üî¥ –ö—Ä–∞—Å–Ω—ã–π (Red)</option>
                        <option value="WHITE" <%= myRequest?.hiveColor === 'WHITE' ? 'selected' : '' %>>‚ö™ –ë–µ–ª—ã–π (White)</option>
                        <option value="MIXED" <%= myRequest?.hiveColor === 'MIXED' ? 'selected' : '' %>>üü£ –°–º–µ—à–∞–Ω–Ω—ã–π (Mixed)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 80 —Å–∏–º–≤.)</label>
                    <input type="text" name="description" 
                           class="custom-input" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—â—É +1 –Ω–∞ –º–∞–∫—Ä–æ –Ω–∞ –ø–æ–ª–µ Pine Tree" 
                           maxlength="80" 
                           value="<%= myRequest?.description || '' %>"
                           required>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-submit">
                        <%= myRequest ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É' %>
                    </button>
                    
                    <% if (myRequest) { %>
                        <button type="button" class="btn-delete" onclick="deleteRequest()" title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    <% } %>
                </div>
            </form>
        </div>
    </div>
    <% } %>

    <script nonce="<%= nonce %>">
        // === –õ–û–ì–ò–ö–ê –ü–ê–ì–ò–ù–ê–¶–ò–ò –ò –§–ò–õ–¨–¢–†–û–í ===
        document.addEventListener('DOMContentLoaded', () => {
            const ITEMS_PER_PAGE = 12; // –°–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            let currentPage = 1;
            let currentFilter = 'ALL';
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            const allCards = Array.from(document.querySelectorAll('.tm-card'));
            const paginationContainer = document.getElementById('paginationControls');
            const emptyState = document.getElementById('emptyState');

            function render() {
                // 1. –§–∏–ª—å—Ç—Ä—É–µ–º
                const filtered = allCards.filter(card => {
                    return currentFilter === 'ALL' || card.dataset.type === currentFilter;
                });

                // 2. –°—á–∏—Ç–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
                
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ, —á–µ–º –≤—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü -> —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                if (currentPage > totalPages) currentPage = 1;
                if (totalPages === 0) currentPage = 1;

                // 3. –í—ã—á–∏—Å–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∫–∞–∑–∞
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;

                // 4. –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ
                allCards.forEach(card => card.style.display = 'none'); // –°–Ω–∞—á–∞–ª–∞ –≤—Å—ë –ø—Ä—è—á–µ–º
                
                if (filtered.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                    filtered.slice(startIndex, endIndex).forEach(card => {
                        card.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        // –ù–µ–±–æ–ª—å—à–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è (—á–∏—Å—Ç—ã–π CSS fade-in)
                        card.style.opacity = '0';
                        card.style.animation = 'fadeIn 0.3s forwards';
                    });
                }

                // 5. –†–∏—Å—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
                renderPagination(totalPages);
            }

            function renderPagination(totalPages) {
                paginationContainer.innerHTML = '';
                if (totalPages <= 1) return; // –ù–µ –Ω—É–∂–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è, –µ—Å–ª–∏ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞

                // –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => { currentPage--; render(); window.scrollTo({top: 0, behavior: 'smooth'}); };
                paginationContainer.appendChild(prevBtn);

                // –¶–∏—Ñ—Ä—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
                for (let i = 1; i <= totalPages; i++) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é, –ø–æ—Å–ª–µ–¥–Ω—é—é, —Ç–µ–∫—É—â—É—é –∏ —Å–æ—Å–µ–¥–µ–π
                    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                        const btn = document.createElement('button');
                        btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                        btn.innerText = i;
                        btn.onclick = () => { currentPage = i; render(); window.scrollTo({top: 0, behavior: 'smooth'}); };
                        paginationContainer.appendChild(btn);
                    } else if (
                        (i === currentPage - 2 && currentPage > 3) || 
                        (i === currentPage + 2 && currentPage < totalPages - 2)
                    ) {
                        // –ú–Ω–æ–≥–æ—Ç–æ—á–∏–µ
                        const span = document.createElement('span');
                        span.innerText = '...';
                        span.style.color = '#666';
                        span.style.paddingTop = '10px';
                        paginationContainer.appendChild(span);
                    }
                }

                // –ö–Ω–æ–ø–∫–∞ –í–ø–µ—Ä–µ–¥
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => { currentPage++; render(); window.scrollTo({top: 0, behavior: 'smooth'}); };
                paginationContainer.appendChild(nextBtn);
            }

            // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            window.setFilter = (type, btn) => {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å active
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentFilter = type;
                currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ 1 —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞
                render();
            };

            // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
            render();
        });

        // --- –î–û–ü. –§–£–ù–ö–¶–ò–ò (–ú–û–î–ê–õ–ö–ê –ò –ö–û–ü–ò–†–û–í–ê–ù–ò–ï) ---
        function openLfgModal() { document.getElementById('lfgModalOverlay')?.classList.add('active'); }
        function closeLfgModal() { document.getElementById('lfgModalOverlay')?.classList.remove('active'); }
        
        document.getElementById('lfgModalOverlay')?.addEventListener('click', (e) => {
            if(e.target.id === 'lfgModalOverlay') closeLfgModal();
        });

        function copyDiscord(username) {
            navigator.clipboard.writeText(username).then(() => {
                // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç —Å–∏—Å—Ç–µ–º—ã —Ç–æ—Å—Ç–æ–≤
                const btn = event.currentTarget; // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
                btn.style.background = '#2ecc71';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.style.background = '';
                }, 2000);
            });
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ ---
        const form = document.getElementById('lfgForm');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                const originalText = btn.innerText;
                btn.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...'; btn.disabled = true;

                const data = Object.fromEntries(new FormData(e.target));
                
                try {
                    const res = await fetch('/teammates/create', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(data) 
                    });
                    const result = await res.json();
                    
                    if (result.success) {
                        location.reload(); 
                    } else {
                        alert(result.error || '–û—à–∏–±–∫–∞');
                        btn.innerText = originalText; btn.disabled = false;
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    btn.innerText = originalText; btn.disabled = false;
                }
            });
        }

        async function deleteRequest() {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
            await fetch('/teammates/delete', { method: 'POST' });
            location.reload();
        }

const LFG_RULES = `
    <ul style="text-align: left; list-style: none; padding: 0; font-size: 0.95rem; color: #ccc;">
        <li style="margin-bottom: 10px;">üïí <b>–°—Ä–æ–∫ –∂–∏–∑–Ω–∏:</b> –∫–∞–∂–¥–∞—è –∑–∞—è–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ <b>30 –º–∏–Ω—É—Ç</b>. –ï—Å–ª–∏ –≤—ã –≤—Å—ë –µ—â–µ –∏—â–µ—Ç–µ ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é</li>
        <li style="margin-bottom: 10px;">‚öñÔ∏è <b>–ü—Ä–∞–≤–∏–ª–∞:</b> –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–∞—Ä—É—à–∞—é—â–∏–π –ø—Ä–∞–≤–∏–ª–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –ü–æ–ª–∏—Ç–∏–∫—É Discord (ToS)</li>
        <li style="margin-bottom: 10px;">ü§ù <b>–£–≤–∞–∂–µ–Ω–∏–µ:</b> –±—É–¥—å—Ç–µ –≤–µ–∂–ª–∏–≤—ã —Å —Ç–µ–º–∏, –∫—Ç–æ –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è. –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø–∞—Ç–∏ ‚Äî —É–¥–∞–ª–∏—Ç–µ –∑–∞—è–≤–∫—É –≤—Ä—É—á–Ω—É—é</li>
        <li style="margin-bottom: 10px;">‚ö†Ô∏è <b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</b> –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –ø–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º —Å—Å—ã–ª–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –º–æ–≥—É—Ç –ø—Ä–∏—Å–ª–∞—Ç—å –≤ –õ–°</li>
    </ul>
`;

function showLfgRules() {
    if (window.Modal) {
        Modal.alert('üìã –ü—Ä–∞–≤–∏–ª–∞ LFG Board', LFG_RULES, 'info');
    } else {
        alert('–ü—Ä–∞–≤–∏–ª–∞:\n1. –ó–∞—è–≤–∫–∏ –∂–∏–≤—É—Ç 30 –º–∏–Ω.\n2. –ë–µ–∑ —Å–ø–∞–º–∞.\n3. –£–¥–∞–ª—è–π—Ç–µ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ.');
    }
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ
document.addEventListener('DOMContentLoaded', () => {
    const hasSeenRules = localStorage.getItem('lfg_rules_seen');
    if (!hasSeenRules) {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Å–∞–π—Ç —É—Å–ø–µ–ª –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è
        setTimeout(() => {
            showLfgRules();
            localStorage.setItem('lfg_rules_seen', 'true');
        }, 1000);
    }
});
    </script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</body>
</html>