<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: 'PIXEL WAR' }) %>
    
    <script src="/js/modals.js"></script>

    <style>
        /* –°–ë–†–û–° –û–¢–°–¢–£–ü–û–í –î–õ–Ø –ü–û–õ–ù–û–ì–û –ü–û–ì–†–£–ñ–ï–ù–ò–Ø */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #050505; }
        
        /* –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ (–ü–ª–∞—é—â–∞—è) */
        .pw-header {
            position: absolute; top: 20px; left: 20px; right: 20px;
            padding: 10px 20px;
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(15px);
            z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 1200px;
            margin: 0 auto;
        }

        .pw-left, .pw-right { display: flex; align-items: center; gap: 15px; }

        .pw-status { font-weight: bold; font-family: monospace; display: flex; gap: 10px; align-items: center; }
        
        .timer-badge { 
            background: #e74c3c; color: white; padding: 6px 12px; border-radius: 8px; 
            font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 5px;
        }
        .ready-badge { 
            background: #2ecc71; color: #fff; padding: 6px 12px; border-radius: 8px; 
            font-size: 0.9rem; display: none; box-shadow: 0 0 15px rgba(46, 204, 113, 0.4); 
            animation: pulse 2s infinite; cursor: default;
        }
        
        .back-btn { 
            color: #ccc; text-decoration: none; font-weight: 600; 
            display: flex; align-items: center; gap: 8px; transition: 0.2s; 
            padding: 5px 10px; border-radius: 8px;
        }
        .back-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }

        .info-btn {
            color: #aaa; font-size: 1.3rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center;
        }
        .info-btn:hover { color: #fff; transform: scale(1.1); }

        /* –•–û–õ–°–¢ - –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù */
        .canvas-container {
            width: 100vw;
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background-color: #050505;
            /* –ï–¥–≤–∞ –∑–∞–º–µ—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ —Ñ–æ–Ω–∞ –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –ø—É—Å—Ç–æ—Ç–µ */
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            cursor: grab;
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }
        .canvas-container:active { cursor: grabbing; }
        
        canvas {
            image-rendering: pixelated; /* –ß–µ—Ç–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏ */
            box-shadow: 0 0 100px rgba(0,0,0,0.8); /* –¢–µ–Ω—å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—è */
        }

        /* –ü–ê–õ–ò–¢–†–ê */
        .palette-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 15, 15, 0.9);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 20px;
            display: flex; gap: 10px;
            z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            /* –°–∫—Ä–æ–ª–ª –¥–ª—è –º–æ–±–∏–ª–æ–∫, –µ—Å–ª–∏ —Ü–≤–µ—Ç–æ–≤ –º–Ω–æ–≥–æ */
            max-width: 90vw;
            overflow-x: auto;
        }
        
        .color-swatch {
            width: 36px; height: 36px;
            min-width: 36px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.1);
            transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .color-swatch:hover { transform: scale(1.1); z-index: 2; }
        .color-swatch.active { 
            border-color: #fff; 
            transform: scale(1.2) translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
        }

        /* –ó–£–ú –ö–û–ù–¢–†–û–õ–´ */
        .zoom-controls {
            position: absolute; bottom: 120px; right: 30px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 100;
        }
        .z-btn {
            width: 50px; height: 50px; 
            background: rgba(15,15,15,0.9); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; cursor: pointer; font-size: 1.2rem;
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .z-btn:hover { background: #333; transform: translateX(-3px); }

        /* –õ–ï–ù–¢–ê –°–û–ë–´–¢–ò–ô */
        .pixel-feed {
            position: absolute; top: 100px; left: 20px;
            pointer-events: none; z-index: 90;
            display: flex; flex-direction: column; gap: 8px;
        }
        .feed-item {
            background: rgba(0,0,0,0.7); 
            padding: 8px 12px; 
            border-radius: 8px;
            border-left: 3px solid #fff;
            color: #ddd;
            font-size: 0.85rem; 
            animation: fadeInOut 4s forwards;
            backdrop-filter: blur(3px);
            max-width: 250px;
            text-shadow: 0 1px 2px black;
        }
        .feed-item b { color: #fff; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateX(-20px); } 10% { opacity: 1; transform: translateX(0); } 80% { opacity: 1; } 100% { opacity: 0; pointer-events: none; } }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤ –¥–ª—è —Ö–µ–¥–µ—Ä–∞ */
        @media (max-width: 600px) {
            .pw-header { flex-direction: column; gap: 10px; align-items: stretch; }
            .pw-left { justify-content: space-between; }
            .pw-right { justify-content: center; }
        }
    </style>
</head>
<body>
    
    <div class="pw-header">
        <div class="pw-left">
            <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i> –í—ã—Ö–æ–¥</a>
            <div class="info-btn" onclick="showRules()">
                <i class="fas fa-question-circle"></i>
            </div>
        </div>
        
        <div class="pw-right">
            <div class="pw-status">
                <span id="cooldownTimer" class="timer-badge"><i class="fas fa-sync fa-spin"></i> ...</span>
                <span id="readyBadge" class="ready-badge">–†–ò–°–£–ô!</span>
            </div>
            
            <div style="font-weight: 600; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 8px;">
                <i class="fas fa-wallet" style="color: #666; margin-right: 5px;"></i>
                <span id="starsDisplay" style="color: #f1c40f;"><%= Math.floor(profile.stars) %></span> ‚≠ê
            </div>
        </div>
    </div>

    <div class="canvas-container" id="container">
        <canvas id="gameCanvas" width="100" height="100"></canvas>
    </div>

    <div class="pixel-feed" id="pixelFeed"></div>

    <div class="zoom-controls">
        <button class="z-btn" onclick="adjustZoom(1)"><i class="fas fa-plus"></i></button>
        <button class="z-btn" onclick="adjustZoom(-1)"><i class="fas fa-minus"></i></button>
        <button class="z-btn" onclick="resetView()"><i class="fas fa-compress-arrows-alt"></i></button>
    </div>

    <div class="palette-bar" id="palette"></div>

    <script src="/socket.io/socket.io.js" nonce="<%= nonce %>"></script>

    <script nonce="<%= nonce %>">
        document.addEventListener('DOMContentLoaded', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª–æ–∫
            if (window.Modal) window.Modal.init();
        });

        // –ü–ê–õ–ò–¢–†–ê
        const COLORS = [
            '#FFFFFF', '#E4E4E4', '#888888', '#222222', 
            '#FFA7D1', '#E50000', '#E59500', '#A06A42', 
            '#E5D900', '#94E044', '#02BE01', '#00D3DD', 
            '#0083C7', '#0000EA', '#CF6EE4', '#820080',
            '#3B180A', '#FF7F50', '#8A2BE2', '#00FF7F'
        ];
        
        let selectedColor = '#FFFFFF';
        let scale = 10; // –°—Ç–∞—Ä—Ç —Å —Ö–æ—Ä–æ—à–∏–º –∑—É–º–æ–º
        const maxScale = 80; // –û–ß–ï–ù–¨ –ë–û–õ–¨–®–û–ô –ó–£–ú (–ü–∏–∫—Å–µ–ª–∏ –∫–∞–∫ –∫–∏—Ä–ø–∏—á–∏)
        const minScale = 0.5; // –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Å—ë –ø–æ–ª–µ –º–µ–ª–∫–∏–º
        
        let offsetX = 0, offsetY = 0;
        let isDragging = false;
        let lastX, lastY;
        
        let lastPixelTime = new Date('<%= profile.lastPixelTime || 0 %>').getTime();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('container');
        
        // 1. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–ê–õ–ò–¢–†–´
        const paletteBox = document.getElementById('palette');
        COLORS.forEach((c, i) => {
            const el = document.createElement('div');
            el.className = 'color-swatch' + (i === 0 ? ' active' : '');
            el.style.backgroundColor = c;
            el.onclick = () => {
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                el.classList.add('active');
                selectedColor = c;
            };
            paletteBox.appendChild(el);
        });

        // 2. –û–¢–†–ò–°–û–í–ö–ê –ò –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø
        function drawPixel(index, color) {
            const x = index % 100;
            const y = Math.floor(index / 100);
            ctx.fillStyle = color;
            ctx.fillRect(x, y, 1, 1);
        }

        function updateTransform() {
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–Ω–≤–∞—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        function centerCanvas() {
            updateTransform();
        }
        centerCanvas();

        // 3. SOCKET.IO
        const socket = io();

        socket.on('connect', () => socket.emit('get_board'));

        socket.on('board_data', (pixels) => {
            pixels.forEach((color, idx) => drawPixel(idx, color));
        });

        socket.on('pixel_update', (data) => {
            drawPixel(data.index, data.color);
            const feed = document.getElementById('pixelFeed');
            const item = document.createElement('div');
            item.className = 'feed-item';
            item.style.borderColor = data.color;
            item.innerHTML = `<b>${data.username}</b> –∑–∞–∫—Ä–∞—Å–∏–ª –ø–∏–∫—Å–µ–ª—å`;
            feed.prepend(item);
            if(feed.children.length > 5) feed.lastChild.remove();
        });

        socket.on('pixel_error', (msg) => {
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú MODAL
            Modal.alert("–û—à–∏–±–∫–∞", msg, "error");
        });

        socket.on('user_update', (data) => {
            if(data.stars) {
                const el = document.getElementById('starsDisplay');
                el.innerText = Math.floor(data.stars);
                el.style.color = '#fff';
                setTimeout(() => el.style.color = '#f1c40f', 300);
            }
        });

        // 4. –ö–õ–ò–ö –ò –†–ò–°–û–í–ê–ù–ò–ï
        let isClick = true;
        container.addEventListener('pointerdown', () => isClick = true);
        container.addEventListener('pointermove', () => isClick = false);

        container.addEventListener('click', async (e) => {
            if (!isClick && isDragging) return;
            if (e.target !== canvas) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);

            if (x >= 0 && x < 100 && y >= 0 && y < 100) {
                const index = y * 100 + x;
                
                const now = Date.now();
                const diff = now - lastPixelTime;
                const cooldown = 5 * 60 * 1000;

                if (diff < cooldown) {
                    // –ò–°–ü–û–õ–¨–ó–£–ï–ú MODAL CONFIRM (await)
                    const confirmed = await Modal.confirm(
                        "‚è≥ –ö—É–ª–¥–∞—É–Ω", 
                        "–¢–∞–π–º–µ—Ä –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫!<br>–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å <b>10 –ó–≤–µ–∑–¥</b>, —á—Ç–æ–±—ã –∑–∞–∫—Ä–∞—Å–∏—Ç—å –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ?", 
                        "warning"
                    );
                    
                    if (!confirmed) return;
                } else {
                    lastPixelTime = now;
                    updateTimer();
                }

                socket.emit('place_pixel', { index, color: selectedColor, userId: '<%= user.id %>' });
            }
        });

        // 5. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô
        container.addEventListener('mousedown', (e) => {
            if(e.button === 0 || e.button === 1) {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
                container.style.cursor = 'grabbing';
            }
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            container.style.cursor = 'grab';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const dx = e.clientX - lastX;
            const dy = e.clientY - lastY;
            offsetX += dx;
            offsetY += dy;
            lastX = e.clientX;
            lastY = e.clientY;
            updateTransform();
        });

        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            // –ë–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–π –∑—É–º –Ω–∞ –∫–æ–ª–µ—Å–∏–∫–µ
            const delta = e.deltaY > 0 ? -2 : 2;
            adjustZoom(delta);
        });

        function adjustZoom(amount) {
            scale += amount;
            if (scale > maxScale) scale = maxScale;
            if (scale < minScale) scale = minScale;
            updateTransform();
        }

        function resetView() {
            scale = 10;
            offsetX = 0;
            offsetY = 0;
            updateTransform();
        }

        // 6. –¢–ê–ô–ú–ï–†
        function updateTimer() {
            const now = Date.now();
            const diff = now - lastPixelTime;
            const cooldown = 5 * 60 * 1000;
            const timeLeft = cooldown - diff;

            const timerBadge = document.getElementById('cooldownTimer');
            const readyBadge = document.getElementById('readyBadge');

            if (timeLeft <= 0) {
                timerBadge.style.display = 'none';
                readyBadge.style.display = 'flex';
            } else {
                readyBadge.style.display = 'none';
                timerBadge.style.display = 'flex';
                
                const m = Math.floor(timeLeft / 60000);
                const s = Math.floor((timeLeft % 60000) / 1000);
                timerBadge.innerHTML = `<i class="fas fa-clock"></i> ${m}:${s.toString().padStart(2, '0')}`;
                requestAnimationFrame(updateTimer);
            }
        }
        updateTimer();

        // 7. INFO (–ò–°–ü–û–õ–¨–ó–£–ï–ú MODAL)
        window.showRules = function() {
            Modal.show(
                "‚öîÔ∏è –ü–†–ê–í–ò–õ–ê PIXEL WAR",
                `<ul style="text-align: left; margin: 0; padding-left: 20px;">
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã –≤–Ω–∏–∑—É.</li>
                    <li>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π –ø–∏–∫—Å–µ–ª—å –Ω–∞ –ø–æ–ª–µ.</li>
                    <li><b>–ú–û–ñ–ù–û</b> –∑–∞–∫—Ä–∞—à–∏–≤–∞—Ç—å —á—É–∂–∏–µ –ø–∏–∫—Å–µ–ª–∏!</li>
                </ul>
                <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">
                <div style="text-align: center;">
                    ‚è≥ <b>–ö—É–ª–¥–∞—É–Ω:</b> 5 –º–∏–Ω—É—Ç<br>
                    üí∞ <b>–ü–ª–∞—Ç–Ω—ã–π —Ö–æ–¥:</b> 10 –ó–≤–µ–∑–¥ (–±–µ–∑ –æ—á–µ—Ä–µ–¥–∏)
                </div>`,
                "info",
                [{ text: "–ü–æ–Ω—è–ª!", class: "btn-confirm" }]
            );
        };
    </script>
</body>
</html>