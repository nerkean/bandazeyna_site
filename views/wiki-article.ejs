<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: title }) %>

    <link rel="preload" href="/css/wiki-article.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/css/wiki-article.css"></noscript>

    <style>
        /* БАЗОВЫЕ СТИЛИ (CRITICAL) */
        :root { --bg: #050505; --text: #ddd; --primary: #5865F2; }
        body { background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; }
        .article-wrapper { max-width: 1000px; margin: 0 auto; padding: 120px 20px 100px; display: flow-root; }
        
        /* СЛАЙДЕР (ФИКС CLS) */
        /* Задаем жесткие размеры сразу здесь */
        .art-slider-wrap {
            float: right;
            width: 380px; 
            height: 280px; /* Фиксируем высоту */
            max-width: 100%;
            margin: 5px 0 20px 30px;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255,255,255,0.02); /* Цвет-заглушка */
            border: 1px solid rgba(255,255,255,0.1);
            contain: layout paint; /* Сообщаем браузеру, что блок изолирован */
        }

        /* Адаптив для слайдера (чтобы не ломался на мобильных) */
        @media (max-width: 1000px) {
            .art-slider-wrap {
                float: none;
                width: 100%;
                /* Рассчитываем высоту для 16:9 на мобилках */
                height: auto;
                aspect-ratio: 16/9;
                margin: 0 0 25px 0;
            }
        }

        /* Остальные критические стили для заголовка, чтобы LCP был быстрым */
        .art-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 25px; margin-bottom: 30px; }
        .art-h1 { font-size: 3rem; font-weight: 900; color: #fff; line-height: 1.1; margin: 10px 0 15px; }
        .content { min-height: 300px; }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="article-wrapper">
        <div class="crumbs">
            <a href="/">Главная</a> / <a href="/wiki">Вики</a> / <%= article.category %>
        </div>

        <header class="art-header">
            <div class="art-tag"><%= article.category.toUpperCase() %></div>
            
            <h1 class="art-h1"><%= article.title %></h1>
            
            <div class="art-meta">
                <div class="meta-item">
                    <i class="far fa-user-circle"></i> <%= article.author %>
                </div>
                <div class="meta-item">
                    <i class="far fa-calendar-alt"></i> <%= new Date(article.createdAt).toLocaleDateString() %>
                </div>
                <div class="meta-item">
                    <i class="far fa-eye"></i> <%= article.views %>
                </div>
            </div>

            <p style="margin-top: 15px; color: #999; font-size: 1rem; line-height: 1.5; max-width: 800px;">
                <%= article.description %>
            </p>
        </header>

        <div class="content">
            <div id="toc-container" style="display: none;">
                <div class="toc-box">
                    <div class="toc-title">Содержание</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </div>
            </div>

            <% 
                let allImages = [];
                if (article.image) allImages.push(article.image);
                if (article.gallery && article.gallery.length > 0) {
                    allImages = allImages.concat(article.gallery);
                }
            %>

           <% if (allImages.length > 0) { %>
                <div class="art-slider-wrap" style="width: 380px; height: 280px; max-width: 100%;">
                    
                    <% if (allImages.length > 1) { %>
                        <button class="slider-btn slider-prev" onclick="moveSlide(-1)" aria-label="Назад"><i class="fas fa-chevron-left"></i></button>
                        <button class="slider-btn slider-next" onclick="moveSlide(1)" aria-label="Вперед"><i class="fas fa-chevron-right"></i></button>
                        <div class="slider-badge">1 / <%= allImages.length %></div>
                    <% } %>

                    <div class="art-slider-track" id="wikiSlider">
                        <% allImages.forEach((img, index) => { %>
                            <div class="art-slide" onclick="openLightbox('<%= img %>')">
                                <img src="<%= img %>" 
                                     alt="<%= article.title %> slide <%= index + 1 %>" 
                                     width="380" 
                                     height="280"
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     loading="<%= index === 0 ? 'eager' : 'lazy' %>" 
                                     fetchpriority="<%= index === 0 ? 'high' : 'auto' %>">
                            </div>
                        <% }) %>
                    </div>
                </div>
            <% } %>

            <%- article.content %>
        </div>

        <% if (article.attachments && article.attachments.length > 0) { %>
            <div class="attachments-box">
                <div class="attach-title">
                    <i class="fas fa-paperclip"></i> Файлы для скачивания
                </div>
                <div class="attach-list">
                    <% article.attachments.forEach(file => { %>
                        <a href="<%= file.path %>" download class="attach-item">
                            <div class="attach-info">
                                <i class="fas fa-file-archive file-icon"></i>
                                <span class="attach-name"><%= file.name %></span>
                            </div>
                            <i class="fas fa-download" style="color: #666;"></i>
                        </a>
                    <% }) %>
                </div>
            </div>
        <% } %>

        <% if (related && related.length > 0) { %>
        <div class="related-box">
            <h3 class="rel-title">Смотрите также</h3>
            <div class="rel-grid">
                <% related.forEach(r => { %>
                    <a href="/wiki/<%= r.slug %>" class="rel-card">
                        <i class="<%= r.icon %>"></i>
                        <span><%= r.title %></span>
                    </a>
                <% }) %>
            </div>
        </div>
        <% } %>
    </div>

    <%- include('partials/footer') %>

    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox(event)" aria-hidden="true" style="display: none;"> <div class="lightbox-content">
            <div class="lightbox-close" onclick="closeLightbox(event)">&times;</div>
            
            <img src="" id="lightboxImg" alt="Full view" width="1920" height="1080">
        </div>
    </div>

    <script nonce="<%= nonce %>">
        const track = document.getElementById('wikiSlider');
        const badge = document.querySelector('.slider-badge');

        function moveSlide(direction) {
            if (!track) return;
            const slideWidth = track.clientWidth;
            track.scrollBy({ left: direction * slideWidth, behavior: 'smooth' });
        }

        if (track && badge) {
            track.addEventListener('scroll', () => {
                const slideWidth = track.clientWidth;
                const scrollPos = track.scrollLeft;
                const currentIndex = Math.round(scrollPos / slideWidth) + 1;
                const total = badge.innerText.split('/')[1]; 
                badge.innerText = `${currentIndex} /${total}`;
            });
        }

        function openLightbox(src) {
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            
            img.src = src;
            
            lb.style.display = 'flex';
            
            requestAnimationFrame(() => {
                lb.classList.add('active');
            });
            
            document.body.style.overflow = 'hidden'; 
        }

        function closeLightbox(e) {
            if (e.target.id === 'lightbox' || e.target.classList.contains('lightbox-close')) {
                const lb = document.getElementById('lightbox');
                lb.classList.remove('active');
                document.body.style.overflow = ''; 
                
                setTimeout(() => { 
                    document.getElementById('lightboxImg').src = ''; 
                    lb.style.display = 'none';
                }, 300);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const contentImages = document.querySelectorAll('.content img:not(.art-slide img)');
            contentImages.forEach(img => {
                img.setAttribute('loading', 'lazy'); 
                img.addEventListener('click', () => {
                    openLightbox(img.src);
                });
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const content = document.querySelector('.content');
            const headings = content.querySelectorAll('h2, h3');
            const tocList = document.getElementById('toc-list');
            const tocContainer = document.getElementById('toc-container');

            if (headings.length > 2) {
                tocContainer.style.display = 'block';
                
                headings.forEach((header, index) => {
                    if (!header.id) header.id = 'section-' + index;

                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = '#' + header.id;
                    a.textContent = header.textContent;
                    
                    if (header.tagName === 'H3') li.classList.add('toc-sub');
                    
                    li.appendChild(a);
                    tocList.appendChild(li);

                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        header.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        history.pushState(null, null, '#' + header.id);
                    });
                });
            }

            const codeBlocks = document.querySelectorAll('pre code, div.code-block'); 
            
            document.querySelectorAll('code').forEach(code => {
                if (code.innerText.length > 20) { 
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-wrapper';

                    code.parentNode.insertBefore(wrapper, code);
                    wrapper.appendChild(code);
                    
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.innerHTML = '<i class="fas fa-copy"></i>';
                    btn.setAttribute('aria-label', 'Скопировать код'); 
                    btn.onclick = () => {
                        navigator.clipboard.writeText(code.innerText);
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i>', 2000);
                    };
                    
                    wrapper.appendChild(btn);
                }
            });
        });
    </script>
</body>
</html>