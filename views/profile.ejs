<% 
    const assetMap = {
        'profile_frame_veteran': 'veteran',
        'profile_frame_laurel_blue': 'laurel_blue',
        'profile_frame_patterned_bronze': 'patterned_bronze',
        'premium_avatar_frame_gold_plated': 'premium_avatar_frame_gold_plated',
        'avatar_frame_azure_spark': 'avatar_frame_azure_spark',
        'hween_frame_web': 'halloween_web',
        'profile_bg_legend': 'legend',
        'profile_bg_stars_dark': 'stars_dark',
        'premium_card_bg_galaxy': 'premium_card_bg_galaxy',
        'hween_bg_pumpkins': 'halloween_pumpkins'
    };

    function getFrameUrl(id) {
        if (!id) return null;
        let filename = assetMap[id];
        if (!filename) filename = id.replace('profile_frame_', '');
        return `/assets/frames/${filename}.webp`; 
    }

    let noIndex = false;

    if (profile.isBanned) {
        noIndex = true;
    }

    if (profile.totalMessages < 5000 && profile.stars < 1000) {
        noIndex = true;
    }

    let headerBgUrl = '/assets/backgrounds/profile_template.png'; 
    let bannerStyle = ''; 
    let headerClass = 'profile-header';

    if (profile.activeCardBgId) {
        let bgName = assetMap[profile.activeCardBgId];
        if (!bgName) bgName = profile.activeCardBgId.replace('profile_bg_', '');
        headerBgUrl = `/assets/backgrounds/${bgName}.webp`; 
        bannerStyle = `background-image: url('${headerBgUrl}');`;
    } else if (profile.profileBannerURL) {
        headerBgUrl = profile.profileBannerURL;
        bannerStyle = `background-image: url('${headerBgUrl}');`;
    } else {
        headerClass += ' default-bg';
    }
%>
<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { 
        title: '–ü—Ä–æ—Ñ–∏–ª—å | ' + targetUser.username,
        description: `–ü—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞ ${targetUser.username} –≤ Bee Swarm Simulator. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –î–∞—á–∞ –ó–µ–π–Ω–∞.`,
        image: targetUser.avatar ? `https://dachazeyna.com/img/proxy/avatar/${targetUser.id}/${targetUser.avatar}` : 'https://dachazeyna.com/assets/img/og-image.png',
        noIndex: noIndex 
    }) %>
    
    <link rel="preload" href="/css/profile.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/css/profile.css"></noscript>
    
    <link rel="stylesheet" href="/css/modals.css" media="print" onload="this.media='all'">
    
    <link rel="preload" as="image" href="<%= headerBgUrl %>" fetchpriority="high">
    
    <style>
        .banned-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(231, 76, 60, 0.15); color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.4);
            padding: 6px 14px; border-radius: 8px;
            font-size: 0.85rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            margin-left: 15px; vertical-align: middle;
        }

        .banned-container {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #180a0a 0%, #0a0202 100%);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 20px;
            padding: 80px 20px;
            text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 0 100px rgba(231, 76, 60, 0.05);
            position: relative; overflow: hidden;
        }

        .banned-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                45deg,
                rgba(231, 76, 60, 0.03),
                rgba(231, 76, 60, 0.03) 10px,
                transparent 10px,
                transparent 20px
            );
            pointer-events: none;
        }

        .banned-icon {
            font-size: 5rem; color: #e74c3c; margin-bottom: 25px;
            text-shadow: 0 0 30px rgba(231, 76, 60, 0.4);
            animation: pulse-red 2s infinite;
        }

        .banned-title {
            font-size: 2.2rem; font-weight: 900; color: #fff; margin-bottom: 15px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .banned-desc {
            color: #bbb; font-size: 1.1rem; max-width: 500px; line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .ban-reason-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 25px; border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: #ff6b6b; font-size: 0.95rem;
            display: inline-block;
        }

        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 0.8; text-shadow: 0 0 20px rgba(231, 76, 60, 0.2); }
            50% { transform: scale(1.05); opacity: 1; text-shadow: 0 0 40px rgba(231, 76, 60, 0.6); }
            100% { transform: scale(1); opacity: 0.8; text-shadow: 0 0 20px rgba(231, 76, 60, 0.2); }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <main class="profile-wrapper">
        
        <header class="<%= headerClass %>" style="<%= bannerStyle %>" role="banner">
            <div class="profile-header-overlay">
                
              <div class="avatar-wrapper">
                    <% if (profile.activeAvatarFrameId) { %>
                        <img src="<%= getFrameUrl(profile.activeAvatarFrameId) %>" class="avatar-frame" alt="–†–∞–º–∫–∞">
                    <% } %>
                    
                    <img src="<%= targetUser.avatar ? `/img/proxy/avatar/${targetUser.id}/${targetUser.avatar}` : '/assets/img/avatars/default_avatar.png' %>" 
     class="avatar-big" 
     alt="–ê–≤–∞—Ç–∞—Ä <%= targetUser.username %>"
     fetchpriority="high">
                </div>
                
                <div class="profile-identity">
                    <h1>
                        <%= targetUser.username %>
                        <% if (profile.isBanned) { %>
                            <span class="banned-badge"><i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        <% } %>
                    </h1>

                    <% if (profile.activeTitle) { %>
                        <span class="user-title"><%= profile.activeTitle %></span>
                    <% } %>
                    
                    <div class="badges">
                        <% if (profile.premiumType) { %>
                            <a href="/shop?category=–ü—Ä–µ–º–∏—É–ºView" class="badge premium"><i class="fas fa-gem"></i> Premium</a>
                        <% } %>
                        <% if (profile.isTaxDelinquent) { %>
                            <span class="badge tax-warning"><i class="fas fa-exclamation-triangle"></i> –î–æ–ª–∂–Ω–∏–∫</span>
                        <% } %>
                        
                        <% if (!profile.isBanned) { %>
                            <span class="badge rep">
                                <i class="fas fa-thumbs-up"></i> –†–µ–ø—É—Ç–∞—Ü–∏—è: <%= profile.reputation %>
                            </span>
                        <% } %>
                    </div>
                </div>

                <% if (isOwner && !profile.isBanned) { %>
                    <button class="btn-edit" onclick="openEditModal()" aria-label="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∏—Ç—É–ª">
                        <i class="fas fa-pen"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∏—Ç—É–ª
                    </button>
                <% } else if (!isOwner && !profile.isBanned) { %>
                    <a href="/messages/<%= targetUser.id %>" class="btn-edit" style="background: var(--primary); border-color: var(--primary);" aria-label="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                        <i class="fas fa-envelope"></i> –ù–∞–ø–∏—Å–∞—Ç—å
                    </a>
                <% } %>
            </div>
        </header>

        <div class="dashboard-grid">
            
            <% if (profile.isBanned) { %>
                <div class="banned-container">
                    <i class="fas fa-user-slash banned-icon"></i>
                    <div class="banned-title">–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç</div>
                    <div class="banned-desc">
                        –î–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ "–ë–∞–Ω–¥–∞ –ó–µ–π–Ω–∞" –≤ —Å–≤—è–∑–∏ —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª.
                    </div>
                    
                    <% if (profile.banReason) { %>
                        <div class="ban-reason-box">
                            <i class="fas fa-info-circle"></i> –ü—Ä–∏—á–∏–Ω–∞: <%= profile.banReason %>
                        </div>
                    <% } %>
                </div>

            <% } else { %>
            
                <div class="col-left">
                    <div class="card glow-card">
                        <h2><i class="fas fa-coins"></i> –§–∏–Ω–∞–Ω—Å—ã <a href="/giveaways" title="–†–æ–∑—ã–≥—Ä—ã—à–∏" aria-label="–†–æ–∑—ã–≥—Ä—ã—à–∏"><i class="fas fa-gift"></i></a></h2>
                        <div class="stat-row"><span>–ù–∞–ª–∏—á–Ω—ã–µ:</span><span class="val gold"><%= Math.floor(profile.stars).toLocaleString() %> ‚≠ê</span></div>
                        <div class="stat-row"><span>–û—Å–∫–æ–ª–∫–∏:</span><span class="val shard"><%= profile.shards %> ‚ú®</span></div>
                        <div class="divider"></div>
                        <div class="stat-row total"><span>Net Worth:</span><span class="val"><%= (typeof netWorth !== 'undefined' ? netWorth : 0).toLocaleString() %> ‚≠ê</span></div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-chart-bar"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
                        <div class="stat-row"><span>–°–æ–æ–±—â–µ–Ω–∏–π:</span><span class="val"><%= profile.totalMessages %></span></div>
                        <div class="stat-row"><span>–ì–æ–ª–æ—Å:</span><span class="val"><%= (profile.totalVoiceTime / 3600).toFixed(1) %> —á.</span></div>
                        <div class="stat-row"><span>–í—Å—Ç—É–ø–∏–ª:</span><span class="val small"><%= new Date(profile.joinedAt).toLocaleDateString() %></span></div>
                    </div>
                    
                    <div class="card">
                        <h2><i class="fas fa-heart"></i> –°–µ–º—å—è</h2>
                        <% if (profile.marriedTo && partnerName) { %>
                            <div class="marriage-info">
                                <div class="heart-icon"><i class="fas fa-heart"></i></div>
                                <div>
                                    <p>–í –±—Ä–∞–∫–µ —Å <strong><%= partnerName %></strong></p>
                                    <p class="small-date">—Å <%= new Date(profile.marriageDate).toLocaleDateString() %></p>
                                </div>
                            </div>
                        <% } else { %>
                            <p class="text-muted">–•–æ–ª–æ—Å—Ç / –ù–µ –∑–∞–º—É–∂–µ–º</p>
                        <% } %>
                    </div>
                </div>

                <div class="col-center">
                    <div class="card graph-card">
                        <h2>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (7 –¥–Ω–µ–π)</h2>
                        <div class="chart-container">
                            <div id="activityChart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-briefcase"></i> –ü–æ—Ä—Ç—Ñ–µ–ª—å –∞–∫—Ü–∏–π</h2>
                        <% if (typeof portfolioDetails !== 'undefined' && portfolioDetails.length > 0) { %>
                            <table class="simple-table">
                                <thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–®—Ç.</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th></tr></thead>
                                <tbody>
                                    <% portfolioDetails.slice(0, 5).forEach(p => { %>
                                        <tr>
                                            <td class="ticker-cell">$<%= p.ticker %></td>
                                            <td><%= p.quantity %></td>
                                            <td><%= p.currentPrice.toFixed(0) %></td>
                                            <td style="color: #ffd700;"><%= p.value.toFixed(0) %></td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                            <% if (portfolioDetails.length > 5) { %>
                                <div style="text-align: center; margin-top: 10px;">
                                    <a href="/market" style="color: var(--primary); font-weight: 700; text-decoration: underline;">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</a>
                                </div>
                            <% } %>
                        <% } else { %>
                            <p class="text-muted">–ü–æ—Ä—Ç—Ñ–µ–ª—å –ø—É—Å—Ç. <a href="/market" style="color: var(--primary);">–ö—É–ø–∏—Ç—å –∞–∫—Ü–∏–∏?</a></p>
                        <% } %>
                    </div>
                    
                    <div class="card">
                        <h2><i class="fas fa-scroll"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã</h2>
                        <% if (typeof quests !== 'undefined' && quests.length > 0) { %>
                            <div class="quest-list">
                                <% quests.forEach(q => { %>
                                    <% if (!q.isCompleted) { %>
                                        <div class="quest-item">
                                            <div class="quest-header">
                                                <span class="quest-name"><%= q.details.name %></span>
                                                <span class="quest-progress"><%= q.progress %> / <%= q.target %></span>
                                            </div>
                                            <div class="progress-bar-bg">
                                                <div class="progress-bar-fill" style="width: <%= (q.progress / q.target) * 100 %>%;"></div>
                                            </div>
                                        </div>
                                    <% } %>
                                <% }) %>
                            </div>
                        <% } else { %>
                            <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤</p>
                        <% } %>
                    </div>
                </div>

                <div class="col-right">
                    <div class="card">
                        <h2><i class="fas fa-box-open"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
                        <div class="inventory-grid">
                            <% profile.inventory.slice(0, 12).forEach(item => { 
                                 let rarity = 'common';
                                 const cat = item.details ? item.details.category : '';
                                 if (cat === '–õ—É—Ç–±–æ–∫—Å') rarity = 'legendary';
                                 else if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è') rarity = 'epic';
                                 
                                 let imgUrl = null;
                                 let showEmoji = true;
                                 if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–ö–æ—Å–º–µ—Ç–∏–∫–∞') {
                                     let fname = assetMap[item.itemId];
                                     if (!fname) fname = item.itemId.replace('profile_frame_', '').replace('profile_bg_', '');
                                     
                                     if(fname.startsWith('avatar_frame_')) fname = fname.replace('avatar_frame_', '');
                                     if(fname.startsWith('premium_avatar_frame_')) fname = fname.replace('premium_avatar_frame_', 'premium_');
                                     if(fname.startsWith('premium_card_bg_')) fname = fname.replace('premium_card_bg_', 'premium_');
                                     
                                     let fld = item.itemId.includes('bg') ? 'backgrounds' : 'frames';
                                     imgUrl = `/assets/thumbnails/${fld}/${fname}.webp`;
                                     showEmoji = false;
                                 } else if (item.details && item.details.imageUrl_web) {
                                     imgUrl = item.details.imageUrl_web;
                                     showEmoji = false;
                                 }
                            %>
                                <div class="inv-item <%= rarity %>" 
                                     style="cursor: pointer;"
                                     onclick="showItemDetails(
                                        '<%= item.details ? item.details.name : item.itemId %>',
                                        '<%= item.details && item.details.description ? item.details.description.replace(/'/g, '\\\'').replace(/\n/g, ' ') : '' %>',
                                        '<%= !showEmoji && imgUrl ? imgUrl : '' %>',
                                        '<%= rarity.toUpperCase() %>',
                                        '<%= item.details ? item.details.emoji : 'üì¶' %>'
                                     )"
                                     title="<%= item.details ? item.details.name : item.itemId %>">
                                     
                                    <div class="inv-icon">
                                        <% if (!showEmoji && imgUrl) { %>
                                            <img src="<%= imgUrl %>" loading="lazy" width="48" height="48" alt="–ü—Ä–µ–¥–º–µ—Ç" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                            <div class="inv-emoji" style="display:none"><%= item.details ? item.details.emoji : 'üì¶' %></div>
                                        <% } else { %>
                                            <div class="inv-emoji"><%= item.details ? item.details.emoji : 'üì¶' %></div>
                                        <% } %>
                                    </div>
                                    <span class="inv-qty">x<%= item.quantity %></span>
                                </div>
                            <% }) %>
                        </div>
                        <% if (isOwner) { %>
                            <a href="/inventory" class="btn-secondary" style="justify-content: center; margin-top: 15px;">–û—Ç–∫—Ä—ã—Ç—å –≤–µ—Å—å</a>
                        <% } %>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-trophy"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
                        <div class="achievements-list">
                            <% if (typeof achievements !== 'undefined' && achievements.length > 0) { %>
                                <% achievements.forEach(ach => { %>
                                    <div class="ach-tag" title="<%= ach.details.description %>">
                                        <%= ach.details.medalEmoji || 'üèÖ' %> <%= ach.details.name %>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</p>
                            <% } %>
                        </div>
                    </div>
                    
                    <% if (isOwner) { %>
                        <div class="card danger-zone">
                            <h2><i class="fas fa-user-secret"></i> –õ–∏—á–Ω–æ–µ</h2>
                            <p>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: <strong><%= profile.warningsReceived %></strong></p>
                            <p>–ú—å—é—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: <strong><%= profile.mutesIssued %></strong></p>
                            <% if (profile.taxDue > 0) { %>
                                 <p class="tax-alert">–ù–∞–ª–æ–≥–æ–≤—ã–π –¥–æ–ª–≥: <%= profile.taxDue %> ‚≠ê</p>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            
            <% } %> 
        </div> 

        <% if (!profile.isBanned) { %>
            <div class="profile-full-row">
                <div class="card">
                    <h2 id="wallHeader"><i class="fas fa-comments"></i> –°—Ç–µ–Ω–∞</h2>
                    
                    <% if (user) { %>
                        <div class="wall-input-box">
                            <% if (user.avatar) { %>
                                <img src="<%= user.avatar ? `/img/proxy/avatar/${user.id}/${user.avatar}` : '/assets/img/avatars/default_avatar.png' %>" 
                                     class="wall-input-ava" 
                                     alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä" 
                                     loading="lazy"
                                     onerror="this.src='/assets/img/avatars/default_avatar.png'">
                            <% } else { %>
                                <img src="https://cdn.discordapp.com/embed/avatars/0.png" class="wall-input-ava" alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä" loading="lazy">
                            <% } %>
                            <input type="text" id="wallComment" class="wall-input" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." maxlength="250" autocomplete="off">
                            
                            <button class="btn-send" onclick="postComment()" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    <% } %>

                    <div class="wall-list" id="commentsList">
                        <div class="loader-spinner"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="wall-pagination" id="wallPagination" style="display: none;"></div>
                </div>
            </div>
        <% } %>

    </main>

    <% if (isOwner && !profile.isBanned) { %>
    <div class="modal-overlay" id="editModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-box">
            <div class="modal-icon"><i class="fas fa-id-badge"></i></div>
            <h2 class="modal-title" id="modalTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–∏—Ç—É–ª–∞</h2>
            
            <div style="margin-bottom: 20px; text-align: center;">
                <% if (profile.inventory.some(i => i.itemId === 'title_token')) { %>
                    <div style="color: #2ecc71; margin-bottom: 5px;">
                        <i class="fas fa-check-circle"></i> <b>–ñ–µ—Ç–æ–Ω –≤ –Ω–∞–ª–∏—á–∏–∏</b>
                    </div>
                    <small style="color: #aaa;">–°–º–µ–Ω–∞ —Å—Ç–æ–∏—Ç 1 –∂–µ—Ç–æ–Ω</small>
                <% } else { %>
                    <div style="color: #ef4444; margin-bottom: 5px;">
                        <i class="fas fa-times-circle"></i> <b>–ù–µ—Ç –ñ–µ—Ç–æ–Ω–∞</b>
                    </div>
                    <small style="color: #aaa;">–ö—É–ø–∏—Ç–µ "–ñ–µ—Ç–æ–Ω –¢–∏—Ç—É–ª–∞" –≤ <a href="/shop" style="color: var(--primary);">–ú–∞–≥–∞–∑–∏–Ω–µ</a></small>
                <% } %>
            </div>

            <input type="text" id="editTitle" class="modal-input" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏—Ç—É–ª (–º–∞–∫—Å. 30)" maxlength="30" 
                   value="<%= profile.activeTitle || '' %>">
            
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-modal btn-secondary" onclick="clearTitle()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="btn-modal btn-confirm" onclick="saveTitle()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <% } %>

    <%- include('partials/footer') %>
    
    <% if (!profile.isBanned) { %>
        <script src="/libs/apexcharts.js" defer></script>
    
    <script nonce="<%= nonce %>">
        const targetProfileId = "<%= targetUser.id %>"; 
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–µ—Ä–µ–¥–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å
        const historyData = <%- JSON.stringify(profile.dailyActivityHistory || []) %>;
        let currentWallPage = 1;

        document.addEventListener('DOMContentLoaded', () => {
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å—Ä–∞–∑—É (–æ–Ω–∏ –Ω—É–∂–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
            loadComments(1);
            
            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ (Enter = –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)
            const wallInput = document.getElementById('wallComment');
            if(wallInput) {
                wallInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') postComment();
                });
            }

            // 3. –û–¢–õ–û–ñ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ì–†–ê–§–ò–ö–ê (–ö–ª—é—á–µ–≤–æ–µ –¥–ª—è TBT –∏ LCP)
            // –ñ–¥–µ–º, –ø–æ–∫–∞ –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Ä–∏—Å—É–µ–º —Ç—è–∂–µ–ª—ã–π –≥—Ä–∞—Ñ–∏–∫
            if (window.requestIdleCallback) {
                window.requestIdleCallback(() => {
                    waitForApex();
                });
            } else {
                setTimeout(waitForApex, 1500); // –§–æ–ª–ª–±—ç–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ApexCharts
        function waitForApex() {
            const check = setInterval(() => {
                if (typeof ApexCharts !== 'undefined') {
                    clearInterval(check);
                    initChart();
                }
            }, 100);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
        function initChart() {
            const chartEl = document.querySelector("#activityChart");
            if (!chartEl) return;
            
            const days = [], msgData = [], voiceData = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push(d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
                
                const found = historyData.find(h => {
                    const hDate = new Date(h.date);
                    return hDate.getDate() === d.getDate() && hDate.getMonth() === d.getMonth();
                });
                
                msgData.push(found ? found.messages : 0);
                voiceData.push(found ? (found.voiceSeconds / 60).toFixed(0) : 0);
            }

            const options = {
                series: [{ name: '–°–æ–æ–±—â–µ–Ω–∏—è', data: msgData }, { name: '–í–æ–π—Å (–º–∏–Ω)', data: voiceData }],
                chart: { 
                    type: 'area', 
                    // –í–∞–∂–Ω–æ: height: '100%' –±–µ—Ä–µ—Ç —Ä–∞–∑–º–µ—Ä –æ—Ç CSS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è —Å–¥–≤–∏–≥ (CLS)
                    height: '100%', 
                    background: 'transparent', 
                    toolbar: { show: false }, 
                    fontFamily: 'Montserrat',
                    animations: { enabled: false } // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                },
                colors: ['#5865F2', '#ffd700'],
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 2 },
                fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.05 } },
                theme: { mode: 'dark' },
                xaxis: { categories: days, labels: { style: { colors: '#888' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { show: false },
                grid: { show: false, padding: { left: 0, right: 0 } }, // –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã
                legend: { show: false }
            };
            
            const chart = new ApexCharts(chartEl, options);
            chart.render();
        }

        // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–º–æ–¥–∞–ª–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
        
        function showItemDetails(name, description, image, rarity, emoji) {
            const rarityColors = {
                'COMMON': '#bdc3c7', 'RARE': '#3498db', 'EPIC': '#9b59b6',
                'LEGENDARY': '#f1c40f', 'MYTHIC': '#e74c3c'
            };
            const color = rarityColors[rarity] || '#fff';

            let visualContent;
            if (image) {
                visualContent = `<img src="${image}" style="width: 80%; height: 80%; object-fit: contain;" alt="–ò–∫–æ–Ω–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞">`;
            } else {
                visualContent = `<div style="font-size: 3.5rem;">${emoji}</div>`;
            }

            const content = `
                <div style="text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 10px 0;">
                    <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 20px; display: flex; align-items: center; justify-content: center; border: 2px solid ${color}; box-shadow: 0 0 25px ${color}30;">${visualContent}</div>
                    <div style="font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; color: ${color}; background: ${color}15; padding: 6px 16px; border-radius: 50px; border: 1px solid ${color}30;">${rarity || 'ITEM'}</div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; width: 100%; border: 1px solid rgba(255,255,255,0.05);">
                        <p style="color: #ccc; margin: 0; font-size: 0.95rem; line-height: 1.6;">${description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}</p>
                    </div>
                </div>
            `;

            if (window.Modal) {
                Modal.show(name, content, 'info', [{ text: '–ó–∞–∫—Ä—ã—Ç—å', handler: 'close' }]);
            } else {
                alert(`${name}\n\n${description}`);
            }
        }

        function openEditModal() { const modal = document.getElementById('editModal'); if (modal) modal.classList.add('active'); }
        function closeEditModal() { const modal = document.getElementById('editModal'); if (modal) modal.classList.remove('active'); }

        async function saveTitle() {
            const title = document.getElementById('editTitle').value;
            if(!title.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ç–∏—Ç—É–ª–∞!");
            if (typeof Modal !== 'undefined') {
                const ok = await Modal.confirm("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–°–º–µ–Ω–∏—Ç—å —Ç–∏—Ç—É–ª? –≠—Ç–æ —Å—Ç–æ–∏—Ç 1 –ñ–µ—Ç–æ–Ω.");
                if(!ok) return;
            }
            sendUpdate(title);
        }

        async function clearTitle() {
            if (typeof Modal !== 'undefined') {
                const ok = await Modal.confirm("–°–±—Ä–æ—Å", "–£–±—Ä–∞—Ç—å —Ç–∏—Ç—É–ª? –≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.");
                if(!ok) return;
            }
            sendUpdate("");
        }

        async function sendUpdate(title) {
            try {
                const res = await fetch('/api/user/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ activeTitle: title })
                });
                const data = await res.json();
                if (data.success) {
                    if (typeof Modal !== 'undefined') await Modal.alert("–£—Å–ø–µ—à–Ω–æ", "–¢–∏—Ç—É–ª –æ–±–Ω–æ–≤–ª–µ–Ω", "success");
                    else alert("–£—Å–ø–µ—à–Ω–æ");
                    location.reload();
                } else {
                    if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", data.error, "error");
                    else alert(data.error);
                }
            } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
        }

        async function loadComments(page) {
            const container = document.getElementById('commentsList');
            try {
                const res = await fetch(`/api/profile/comments/${targetProfileId}?page=${page}`);
                const data = await res.json();

                if (data.success) {
                    currentWallPage = data.pagination.current;
                    if (data.comments.length > 0) {
                        container.innerHTML = data.comments.map(c => {
                            const avaUrl = c.authorAvatar 
                                ? `/img/proxy/avatar/${c.authorId}/${c.authorAvatar}` 
                                : '/assets/img/avatars/default_avatar.png';
                            const safeText = c.comment.replace(/&/g, "&amp;").replace(/</g, "&lt;");
                            
                            return `
                                <div class="wall-item">
                                    <a href="/profile/${c.authorId}">
                                        <img src="${avaUrl}" class="wall-ava" alt="–ê–≤–∞—Ç–∞—Ä ${c.authorUsername}" loading="lazy" onerror="this.src='/assets/img/avatars/default_avatar.png'">
                                    </a>
                                    <div class="wall-bubble">
                                        <div class="wall-meta">
                                            <a href="/profile/${c.authorId}" class="wall-author">${c.authorUsername}</a>
                                            <span class="wall-date">${new Date(c.timestamp).toLocaleDateString()}</span>
                                        </div>
                                        <div class="wall-text">${safeText}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<div class="wall-empty">–ó–¥–µ—Å—å –ø–æ–∫–∞ —Ç–∏—Ö–æ...</div>';
                    }
                    renderPagination(data.pagination.current, data.pagination.total);
                }
            } catch (e) { container.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; }
        }

        function renderPagination(current, total) {
            const p = document.getElementById('wallPagination');
            if(total <= 1) { p.style.display = 'none'; return; }
            p.style.display = 'flex';
            let html = `<button class="page-btn" onclick="loadComments(${current - 1})" ${current === 1 ? 'disabled' : ''}>&lt;</button>`;
            html += `<span style="color:#888; font-weight:600;"> ${current} / ${total} </span>`;
            html += `<button class="page-btn" onclick="loadComments(${current + 1})" ${current === total ? 'disabled' : ''}>&gt;</button>`;
            p.innerHTML = html;
        }

        async function postComment() {
            const input = document.getElementById('wallComment');
            if (!input) return;
            const text = input.value;
            if (!text.trim()) return;

            try {
                const res = await fetch('/api/profile/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUserId: targetProfileId, text: text })
                });
                const data = await res.json();
                if (data.success) {
                    input.value = '';
                    loadComments(1);
                } else {
                    if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", data.error, "error");
                    else alert(data.error);
                }
            } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
        }
    </script>
    <% } %>
</body>
</html>