<% 
    // --- –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –§–û–ù–ê –ò –†–ê–ú–û–ö ---
    // –í–ê–ñ–ù–û: –ó–Ω–∞—á–µ–Ω–∏—è –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã —Ç–æ—á—å-–≤-—Ç–æ—á—å —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–∞—Ö public/assets/frames –∏ public/assets/backgrounds
    const assetMap = {
        // –†–∞–º–∫–∏
        'profile_frame_veteran': 'veteran',
        'profile_frame_laurel_blue': 'laurel_blue',
        'profile_frame_patterned_bronze': 'patterned_bronze',
        'premium_avatar_frame_gold_plated': 'premium_avatar_frame_gold_plated', // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞
        'avatar_frame_azure_spark': 'avatar_frame_azure_spark', // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞
        'hween_frame_web': 'halloween_web',
        
        // –§–æ–Ω—ã
        'profile_bg_legend': 'legend',
        'profile_bg_stars_dark': 'stars_dark',
        'premium_card_bg_galaxy': 'premium_card_bg_galaxy', // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞
        'hween_bg_pumpkins': 'halloween_pumpkins'
    };

    function getFrameUrl(id) {
        if (!id) return null;
        let filename = assetMap[id];
        // –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ –≤ –º–∞–ø–µ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º —É–±—Ä–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
        if (!filename) filename = id.replace('profile_frame_', '');
        return `/assets/frames/${filename}.webp`; 
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL —Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
    let headerBgUrl = '/assets/backgrounds/profile_template.png'; 
    let bannerStyle = ''; 
    let headerClass = 'profile-header';

    if (profile.activeCardBgId) {
        let bgName = assetMap[profile.activeCardBgId];
        if (!bgName) bgName = profile.activeCardBgId.replace('profile_bg_', '');
        
        headerBgUrl = `/assets/backgrounds/${bgName}.webp`; 
        bannerStyle = `background-image: url('${headerBgUrl}');`;
    } else if (profile.profileBannerURL) {
        headerBgUrl = profile.profileBannerURL;
        bannerStyle = `background-image: url('${headerBgUrl}');`;
    } else {
        headerClass += ' default-bg';
    }
%>
<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: '–ü—Ä–æ—Ñ–∏–ª—å | ' + targetUser.username }) %>
    <link rel="stylesheet" href="/css/profile.css">
    <link rel="stylesheet" href="/css/modals.css">
    
    <link rel="preload" as="image" href="<%= headerBgUrl %>" fetchpriority="high">
    
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è */
        .banned-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(231, 76, 60, 0.15); color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.4);
            padding: 6px 14px; border-radius: 8px;
            font-size: 0.85rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            margin-left: 15px; vertical-align: middle;
        }

        .banned-container {
            grid-column: 1 / -1; /* –†–∞—Å—Ç—è–Ω—É—Ç—å –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å–µ—Ç–∫–∏ */
            background: linear-gradient(135deg, #180a0a 0%, #0a0202 100%);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 20px;
            padding: 80px 20px;
            text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 0 100px rgba(231, 76, 60, 0.05);
            position: relative; overflow: hidden;
        }

        /* –§–æ–Ω–æ–≤—ã–π —É–∑–æ—Ä */
        .banned-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                45deg,
                rgba(231, 76, 60, 0.03),
                rgba(231, 76, 60, 0.03) 10px,
                transparent 10px,
                transparent 20px
            );
            pointer-events: none;
        }

        .banned-icon {
            font-size: 5rem; color: #e74c3c; margin-bottom: 25px;
            text-shadow: 0 0 30px rgba(231, 76, 60, 0.4);
            animation: pulse-red 2s infinite;
        }

        .banned-title {
            font-size: 2.2rem; font-weight: 900; color: #fff; margin-bottom: 15px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .banned-desc {
            color: #bbb; font-size: 1.1rem; max-width: 500px; line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .ban-reason-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 25px; border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: #ff6b6b; font-size: 0.95rem;
            display: inline-block;
        }

        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 0.8; text-shadow: 0 0 20px rgba(231, 76, 60, 0.2); }
            50% { transform: scale(1.05); opacity: 1; text-shadow: 0 0 40px rgba(231, 76, 60, 0.6); }
            100% { transform: scale(1); opacity: 0.8; text-shadow: 0 0 20px rgba(231, 76, 60, 0.2); }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="profile-wrapper">
        
        <header class="<%= headerClass %>" style="<%= bannerStyle %>" role="banner">
            <div class="profile-header-overlay">
                
              <div class="avatar-wrapper">
                    <% if (profile.activeAvatarFrameId) { %>
                        <img src="<%= getFrameUrl(profile.activeAvatarFrameId) %>" class="avatar-frame" alt="–†–∞–º–∫–∞">
                    <% } %>
                    
                    <img src="<%= targetUser.avatar ? `/img/proxy/avatar/${targetUser.id}/${targetUser.avatar}` : '/assets/img/avatars/default_avatar.png' %>" 
                         class="avatar-big" alt="–ê–≤–∞—Ç–∞—Ä">
                </div>
                
                <div class="profile-identity">
                    <h1>
                        <%= targetUser.username %>
                        <% if (profile.isBanned) { %>
                            <span class="banned-badge"><i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        <% } %>
                    </h1>

                    <% if (profile.activeTitle) { %>
                        <span class="user-title"><%= profile.activeTitle %></span>
                    <% } %>
                    
                    <div class="badges">
                        <% if (profile.premiumType) { %>
                            <a href="/shop?category=–ü—Ä–µ–º–∏—É–ºView" class="badge premium"><i class="fas fa-gem"></i> Premium</a>
                        <% } %>
                        <% if (profile.isTaxDelinquent) { %>
                            <span class="badge tax-warning"><i class="fas fa-exclamation-triangle"></i> –î–æ–ª–∂–Ω–∏–∫</span>
                        <% } %>
                        
                        <% if (!profile.isBanned) { %>
                            <span class="badge rep">
                                <i class="fas fa-thumbs-up"></i> –†–µ–ø—É—Ç–∞—Ü–∏—è: <%= profile.reputation %>
                            </span>
                        <% } %>
                    </div>
                </div>

                <% if (isOwner && !profile.isBanned) { %>
                    <button class="btn-edit" onclick="openEditModal()">
                        <i class="fas fa-pen"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∏—Ç—É–ª
                    </button>
                <% } else if (!isOwner && !profile.isBanned) { %>
                    <a href="/messages/<%= targetUser.id %>" class="btn-edit" style="background: var(--primary); border-color: var(--primary);">
                        <i class="fas fa-envelope"></i> –ù–∞–ø–∏—Å–∞—Ç—å
                    </a>
                <% } %>
            </div>
        </header>

        <div class="dashboard-grid">
            
            <% if (profile.isBanned) { %>
                <div class="banned-container">
                    <i class="fas fa-user-slash banned-icon"></i>
                    <div class="banned-title">–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç</div>
                    <div class="banned-desc">
                        –î–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ "–ë–∞–Ω–¥–∞ –ó–µ–π–Ω–∞" –≤ —Å–≤—è–∑–∏ —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª.
                    </div>
                    
                    <% if (profile.banReason) { %>
                        <div class="ban-reason-box">
                            <i class="fas fa-info-circle"></i> –ü—Ä–∏—á–∏–Ω–∞: <%= profile.banReason %>
                        </div>
                    <% } %>
                </div>

            <% } else { %>
            
                <div class="col-left">
                    <div class="card glow-card">
                        <h2><i class="fas fa-coins"></i> –§–∏–Ω–∞–Ω—Å—ã <a href="/giveaways" title="–†–æ–∑—ã–≥—Ä—ã—à–∏"><i class="fas fa-gift"></i></a></h2>
                        <div class="stat-row"><span>–ù–∞–ª–∏—á–Ω—ã–µ:</span><span class="val gold"><%= Math.floor(profile.stars).toLocaleString() %> ‚≠ê</span></div>
                        <div class="stat-row"><span>–û—Å–∫–æ–ª–∫–∏:</span><span class="val shard"><%= profile.shards %> ‚ú®</span></div>
                        <div class="divider"></div>
                        <div class="stat-row total"><span>Net Worth:</span><span class="val"><%= (typeof netWorth !== 'undefined' ? netWorth : 0).toLocaleString() %> ‚≠ê</span></div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-chart-bar"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
                        <div class="stat-row"><span>–°–æ–æ–±—â–µ–Ω–∏–π:</span><span class="val"><%= profile.totalMessages %></span></div>
                        <div class="stat-row"><span>–ì–æ–ª–æ—Å:</span><span class="val"><%= (profile.totalVoiceTime / 3600).toFixed(1) %> —á.</span></div>
                        <div class="stat-row"><span>–í—Å—Ç—É–ø–∏–ª:</span><span class="val small"><%= new Date(profile.joinedAt).toLocaleDateString() %></span></div>
                    </div>
                    
                    <div class="card">
                        <h2><i class="fas fa-heart"></i> –°–µ–º—å—è</h2>
                        <% if (profile.marriedTo && partnerName) { %>
                            <div class="marriage-info">
                                <div class="heart-icon"><i class="fas fa-heart"></i></div>
                                <div>
                                    <p>–í –±—Ä–∞–∫–µ —Å <strong><%= partnerName %></strong></p>
                                    <p class="small-date">—Å <%= new Date(profile.marriageDate).toLocaleDateString() %></p>
                                </div>
                            </div>
                        <% } else { %>
                            <p class="text-muted">–•–æ–ª–æ—Å—Ç / –ù–µ –∑–∞–º—É–∂–µ–º</p>
                        <% } %>
                    </div>
                </div>

                <div class="col-center">
                    <div class="card graph-card">
                        <h2>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (7 –¥–Ω–µ–π)</h2>
                        <div class="chart-container">
                            <div id="activityChart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-briefcase"></i> –ü–æ—Ä—Ç—Ñ–µ–ª—å –∞–∫—Ü–∏–π</h2>
                        <% if (typeof portfolioDetails !== 'undefined' && portfolioDetails.length > 0) { %>
                            <table class="simple-table">
                                <thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–®—Ç.</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th></tr></thead>
                                <tbody>
                                    <% portfolioDetails.slice(0, 5).forEach(p => { %>
                                        <tr>
                                            <td class="ticker-cell">$<%= p.ticker %></td>
                                            <td><%= p.quantity %></td>
                                            <td><%= p.currentPrice.toFixed(0) %></td>
                                            <td style="color: #ffd700;"><%= p.value.toFixed(0) %></td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                            <% if (portfolioDetails.length > 5) { %>
                                <div style="text-align: center; margin-top: 10px;">
                                    <a href="/market" style="color: var(--primary); font-weight: 700;">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</a>
                                </div>
                            <% } %>
                        <% } else { %>
                            <p class="text-muted">–ü–æ—Ä—Ç—Ñ–µ–ª—å –ø—É—Å—Ç. <a href="/market" style="color: var(--primary);">–ö—É–ø–∏—Ç—å –∞–∫—Ü–∏–∏?</a></p>
                        <% } %>
                    </div>
                    
                    <div class="card">
                        <h2><i class="fas fa-scroll"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã</h2>
                        <% if (typeof quests !== 'undefined' && quests.length > 0) { %>
                            <div class="quest-list">
                                <% quests.forEach(q => { %>
                                    <% if (!q.isCompleted) { %>
                                        <div class="quest-item">
                                            <div class="quest-header">
                                                <span class="quest-name"><%= q.details.name %></span>
                                                <span class="quest-progress"><%= q.progress %> / <%= q.target %></span>
                                            </div>
                                            <div class="progress-bar-bg">
                                                <div class="progress-bar-fill" style="width: <%= (q.progress / q.target) * 100 %>%;"></div>
                                            </div>
                                        </div>
                                    <% } %>
                                <% }) %>
                            </div>
                        <% } else { %>
                            <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤</p>
                        <% } %>
                    </div>
                </div>

                <div class="col-right">
                    <div class="card">
                        <h2><i class="fas fa-box-open"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
                        <div class="inventory-grid">
                            <% profile.inventory.slice(0, 12).forEach(item => { 
                                 let rarity = 'common';
                                 const cat = item.details ? item.details.category : '';
                                 if (cat === '–õ—É—Ç–±–æ–∫—Å') rarity = 'legendary';
                                 else if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è') rarity = 'epic';
                                 
                                 let imgUrl = null;
                                 let showEmoji = true;
                                 if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–ö–æ—Å–º–µ—Ç–∏–∫–∞') {
                                     // –î–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –±–µ—Ä–µ–º –∏–∑ thumbnails –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                                     let fname = assetMap[item.itemId];
                                     if (!fname) fname = item.itemId.replace('profile_frame_', '').replace('profile_bg_', '');
                                     
                                     // –ù–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏–º–µ–Ω–∞ –≤ thumbnails —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å assetMap...
                                     // –£—á–∏—Ç—ã–≤–∞—è —Ç–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≤ thumbnails –∏–º–µ–Ω–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–º–∏ (–±–µ–∑ avatar_frame_)
                                     // –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —Ö–∞–∫: –µ—Å–ª–∏ –≤ assetMap –µ—Å—Ç—å 'avatar_frame_', —É–±–µ—Ä–µ–º –µ–≥–æ –¥–ª—è thumbnails
                                     if(fname.startsWith('avatar_frame_')) fname = fname.replace('avatar_frame_', '');
                                     if(fname.startsWith('premium_avatar_frame_')) fname = fname.replace('premium_avatar_frame_', 'premium_');
                                     if(fname.startsWith('premium_card_bg_')) fname = fname.replace('premium_card_bg_', 'premium_');
                                     
                                     let fld = item.itemId.includes('bg') ? 'backgrounds' : 'frames';
                                     imgUrl = `/assets/thumbnails/${fld}/${fname}.webp`;
                                     showEmoji = false;
                                 } else if (item.details && item.details.imageUrl_web) {
                                     imgUrl = item.details.imageUrl_web;
                                     showEmoji = false;
                                 }
                            %>
                                <div class="inv-item <%= rarity %>" title="<%= item.details ? item.details.name : item.itemId %>">
                                    <div class="inv-icon">
                                        <% if (!showEmoji && imgUrl) { %>
                                            <img src="<%= imgUrl %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                            <div class="inv-emoji" style="display:none"><%= item.details ? item.details.emoji : 'üì¶' %></div>
                                        <% } else { %>
                                            <div class="inv-emoji"><%= item.details ? item.details.emoji : 'üì¶' %></div>
                                        <% } %>
                                    </div>
                                    <span class="inv-qty">x<%= item.quantity %></span>
                                </div>
                            <% }) %>
                        </div>
                        <% if (isOwner) { %>
                            <a href="/inventory" class="btn-secondary" style="justify-content: center; margin-top: 15px;">–û—Ç–∫—Ä—ã—Ç—å –≤–µ—Å—å</a>
                        <% } %>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-trophy"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
                        <div class="achievements-list">
                            <% if (typeof achievements !== 'undefined' && achievements.length > 0) { %>
                                <% achievements.forEach(ach => { %>
                                    <div class="ach-tag" title="<%= ach.details.description %>">
                                        <%= ach.details.medalEmoji || 'üèÖ' %> <%= ach.details.name %>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</p>
                            <% } %>
                        </div>
                    </div>
                    
                    <% if (isOwner) { %>
                        <div class="card danger-zone">
                            <h2><i class="fas fa-user-secret"></i> –õ–∏—á–Ω–æ–µ</h2>
                            <p>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: <strong><%= profile.warningsReceived %></strong></p>
                            <p>–ú—å—é—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: <strong><%= profile.mutesIssued %></strong></p>
                            <% if (profile.taxDue > 0) { %>
                                 <p class="tax-alert">–ù–∞–ª–æ–≥–æ–≤—ã–π –¥–æ–ª–≥: <%= profile.taxDue %> ‚≠ê</p>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            
            <% } %> </div> 

        <% if (!profile.isBanned) { %>
            <div class="profile-full-row">
                <div class="card">
                    <h2 id="wallHeader"><i class="fas fa-comments"></i> –°—Ç–µ–Ω–∞</h2>
                    
                    <% if (user) { %>
                        <div class="wall-input-box">
                            <% if (user.avatar) { %>
                                <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png" class="wall-input-ava" alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä">
                            <% } else { %>
                                <img src="https://cdn.discordapp.com/embed/avatars/0.png" class="wall-input-ava" alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä">
                            <% } %>
                            <input type="text" id="wallComment" class="wall-input" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." maxlength="250" autocomplete="off">
                            <button class="btn-send" onclick="postComment()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    <% } %>

                    <div class="wall-list" id="commentsList">
                        <div class="loader-spinner"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="wall-pagination" id="wallPagination" style="display: none;"></div>
                </div>
            </div>
        <% } %>

    </div>

    <% if (isOwner && !profile.isBanned) { %>
    <div class="modal-overlay" id="editModal" role="dialog" aria-modal="true">
        <div class="modal-box">
            <div class="modal-icon"><i class="fas fa-id-badge"></i></div>
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–∏—Ç—É–ª–∞</h2>
            
            <div style="margin-bottom: 20px; text-align: center;">
                <% if (profile.inventory.some(i => i.itemId === 'title_token')) { %>
                    <div style="color: #2ecc71; margin-bottom: 5px;">
                        <i class="fas fa-check-circle"></i> <b>–ñ–µ—Ç–æ–Ω –≤ –Ω–∞–ª–∏—á–∏–∏</b>
                    </div>
                    <small style="color: #aaa;">–°–º–µ–Ω–∞ —Å—Ç–æ–∏—Ç 1 –∂–µ—Ç–æ–Ω</small>
                <% } else { %>
                    <div style="color: #ef4444; margin-bottom: 5px;">
                        <i class="fas fa-times-circle"></i> <b>–ù–µ—Ç –ñ–µ—Ç–æ–Ω–∞</b>
                    </div>
                    <small style="color: #aaa;">–ö—É–ø–∏—Ç–µ "–ñ–µ—Ç–æ–Ω –¢–∏—Ç—É–ª–∞" –≤ <a href="/shop" style="color: var(--primary);">–ú–∞–≥–∞–∑–∏–Ω–µ</a></small>
                <% } %>
            </div>

            <input type="text" id="editTitle" class="modal-input" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏—Ç—É–ª (–º–∞–∫—Å. 30)" maxlength="30" 
                   value="<%= profile.activeTitle || '' %>">
            
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-modal btn-secondary" onclick="clearTitle()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="btn-modal btn-confirm" onclick="saveTitle()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <% } %>

    <%- include('partials/footer') %>
    
    <% if (!profile.isBanned) { %>
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <script nonce="<%= nonce %>">
            const targetProfileId = "<%= targetUser.id %>"; 
            const historyData = <%- JSON.stringify(profile.dailyActivityHistory || []) %>;
            let currentWallPage = 1;

            document.addEventListener('DOMContentLoaded', () => {
                loadComments(1);
                initChart();

                const wallInput = document.getElementById('wallComment');
                if(wallInput) {
                    wallInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') postComment();
                    });
                }
            });

            // --- MODALS ---
            function openEditModal() { 
                const modal = document.getElementById('editModal');
                if (modal) modal.classList.add('active'); 
            }
            function closeEditModal() { 
                const modal = document.getElementById('editModal');
                if (modal) modal.classList.remove('active'); 
            }

            // --- ACTIONS ---
            async function saveTitle() {
                const title = document.getElementById('editTitle').value;
                if(!title.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ç–∏—Ç—É–ª–∞!");

                if (typeof Modal !== 'undefined') {
                    const ok = await Modal.confirm("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–°–º–µ–Ω–∏—Ç—å —Ç–∏—Ç—É–ª? –≠—Ç–æ —Å—Ç–æ–∏—Ç 1 –ñ–µ—Ç–æ–Ω.");
                    if(!ok) return;
                }
                sendUpdate(title);
            }

            async function clearTitle() {
                if (typeof Modal !== 'undefined') {
                    const ok = await Modal.confirm("–°–±—Ä–æ—Å", "–£–±—Ä–∞—Ç—å —Ç–∏—Ç—É–ª? –≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.");
                    if(!ok) return;
                }
                sendUpdate("");
            }

            async function sendUpdate(title) {
                try {
                    const res = await fetch('/api/user/update', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ activeTitle: title })
                    });
                    const data = await res.json();

                    if (data.success) {
                        if (typeof Modal !== 'undefined') await Modal.alert("–£—Å–ø–µ—à–Ω–æ", "–¢–∏—Ç—É–ª –æ–±–Ω–æ–≤–ª–µ–Ω", "success");
                        else alert("–£—Å–ø–µ—à–Ω–æ");
                        location.reload();
                    } else {
                        if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", data.error, "error");
                        else alert(data.error);
                    }
                } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
            }

            // --- CHART ---
            function initChart() {
                if (typeof ApexCharts === 'undefined') return;
                
                const days = [], msgData = [], voiceData = [];
                
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    days.push(d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
                    
                    const found = historyData.find(h => {
                        const hDate = new Date(h.date);
                        return hDate.getDate() === d.getDate() && hDate.getMonth() === d.getMonth();
                    });
                    
                    msgData.push(found ? found.messages : 0);
                    voiceData.push(found ? (found.voiceSeconds / 60).toFixed(0) : 0);
                }

                const options = {
                    series: [{ name: '–°–æ–æ–±—â–µ–Ω–∏—è', data: msgData }, { name: '–í–æ–π—Å (–º–∏–Ω)', data: voiceData }],
                    chart: { type: 'area', height: 220, background: 'transparent', toolbar: { show: false }, fontFamily: 'Montserrat' },
                    colors: ['#5865F2', '#ffd700'],
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.05 } },
                    theme: { mode: 'dark' },
                    xaxis: { categories: days, labels: { style: { colors: '#888' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { show: false },
                    grid: { show: false },
                    legend: { show: false }
                };
                
                const chart = new ApexCharts(document.querySelector("#activityChart"), options);
                chart.render();
            }

            // --- COMMENTS ---
            async function loadComments(page) {
                const container = document.getElementById('commentsList');
                try {
                    const res = await fetch(`/api/profile/comments/${targetProfileId}?page=${page}`);
                    const data = await res.json();

                    if (data.success) {
                        currentWallPage = data.pagination.current;
                        if (data.comments.length > 0) {
                            container.innerHTML = data.comments.map(c => {
                                const avaUrl = c.authorAvatar ? `https://cdn.discordapp.com/avatars/${c.authorId}/${c.authorAvatar}.png` : '/assets/img/avatars/default_avatar.png';
                                const safeText = c.comment.replace(/&/g, "&amp;").replace(/</g, "&lt;");
                                return `
                                    <div class="wall-item">
                                        <a href="/profile/${c.authorId}"><img src="${avaUrl}" class="wall-ava" onerror="this.src='/assets/img/avatars/default_avatar.png'"></a>
                                        <div class="wall-bubble">
                                            <div class="wall-meta">
                                                <a href="/profile/${c.authorId}" class="wall-author">${c.authorUsername}</a>
                                                <span class="wall-date">${new Date(c.timestamp).toLocaleDateString()}</span>
                                            </div>
                                            <div class="wall-text">${safeText}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            container.innerHTML = '<div class="wall-empty">–ó–¥–µ—Å—å –ø–æ–∫–∞ —Ç–∏—Ö–æ...</div>';
                        }
                        renderPagination(data.pagination.current, data.pagination.total);
                    }
                } catch (e) { container.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; }
            }

            function renderPagination(current, total) {
                const p = document.getElementById('wallPagination');
                if(total <= 1) { p.style.display = 'none'; return; }
                p.style.display = 'flex';
                let html = `<button class="page-btn" onclick="loadComments(${current - 1})" ${current === 1 ? 'disabled' : ''}>&lt;</button>`;
                html += `<span style="color:#888; font-weight:600;"> ${current} / ${total} </span>`;
                html += `<button class="page-btn" onclick="loadComments(${current + 1})" ${current === total ? 'disabled' : ''}>&gt;</button>`;
                p.innerHTML = html;
            }

            async function postComment() {
                const input = document.getElementById('wallComment');
                if (!input) return;
                const text = input.value;
                if (!text.trim()) return;

                try {
                    const res = await fetch('/api/profile/comment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ targetUserId: targetProfileId, text: text })
                    });
                    const data = await res.json();
                    if (data.success) {
                        input.value = '';
                        loadComments(1);
                    } else {
                        if (typeof Modal !== 'undefined') Modal.alert("–û—à–∏–±–∫–∞", data.error, "error");
                        else alert(data.error);
                    }
                } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
            }
        </script>
    <% } %>
</body>
</html>