<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head', { title: '–ü—Ä–æ—Ñ–∏–ª—å | ' + targetUser.username }) %>
    <link rel="stylesheet" href="/css/profile.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <% 
        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–¢–ò–ù–û–ö (MAPPING) ---
        const assetMap = {
            // –†–∞–º–∫–∏
            'profile_frame_veteran': 'veteran',
            'profile_frame_laurel_blue': 'laurel_blue',
            'profile_frame_patterned_bronze': 'patterned_bronze',
            'premium_avatar_frame_gold_plated': 'premium_gold_plated',
            'avatar_frame_azure_spark': 'azure_spark',
            'hween_frame_web': 'halloween_web',
            
            // –§–æ–Ω—ã
            'profile_bg_legend': 'legend',
            'profile_bg_stars_dark': 'stars_dark',
            'premium_card_bg_galaxy': 'premium_galaxy',
            'hween_bg_pumpkins': 'halloween_pumpkins'
        };

        function getAssetUrl(id, type) {
            if (!id) return null;
            // 1. –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ –∫–∞—Ä—Ç–µ
            let filename = assetMap[id];
            
            // 2. –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º —É–º–Ω—É—é –æ—á–∏—Å—Ç–∫—É
            if (!filename) {
                filename = id.replace('profile_frame_', '').replace('profile_bg_', '');
            }
            
            return `/assets/${type}/${filename}.webp`;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —à–∞–ø–∫–∏
        let bannerStyle = ''; 
        let headerClass = 'profile-header';
        
        if (profile.activeCardBgId) {
            bannerStyle = `background-image: url('${getAssetUrl(profile.activeCardBgId, 'backgrounds')}');`;
        } else {
            headerClass += ' default-bg';
        }
    %>

    <div class="profile-wrapper">
        <header class="<%= headerClass %>" style="<%= bannerStyle %>">
            <div class="profile-header-overlay">
                <div class="avatar-wrapper">
                    
                   <% 
    // –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É—Ç–∏
    function getFrameUrl(id) {
        if (!id) return null;
        let filename = assetMap[id];
        if (!filename) filename = id.replace('profile_frame_', '');
        // [FIX] –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É
        return `/assets/thumbnails/frames/${filename}.webp`; 
    }
%>
<img src="<%= getFrameUrl(profile.activeAvatarFrameId) %>" class="avatar-frame" alt="frame">
                    
                    <% if (targetUser.avatar) { %>
                        <img src="https://cdn.discordapp.com/avatars/<%= targetUser.id %>/<%= targetUser.avatar %>.png" class="avatar-big">
                    <% } else { %>
                        <img src="https://cdn.discordapp.com/embed/avatars/0.png" class="avatar-big">
                    <% } %>
                </div>
                
                <div class="profile-identity">
                    <h1><%= targetUser.username %></h1>
                    <% if (profile.activeTitle) { %>
                        <span class="user-title"><%= profile.activeTitle %></span>
                    <% } %>
                    
                    <div class="badges">
                        <% if (profile.premiumType) { %>
                            <a href="/shop?category=–ü—Ä–µ–º–∏—É–ºView" class="badge premium" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π">
                                <i class="fas fa-gem"></i> Premium
                            </a>
                        <% } %>
                        <% if (profile.isTaxDelinquent) { %>
                            <span class="badge tax-warning"><i class="fas fa-exclamation-triangle"></i> –î–æ–ª–∂–Ω–∏–∫</span>
                        <% } %>
                        <span class="badge rep"><i class="fas fa-thumbs-up"></i> –†–µ–ø—É—Ç–∞—Ü–∏—è: <%= profile.reputation %></span>
                    </div>
                </div>

                <% if (isOwner) { %>
                    <button class="btn-edit" onclick="openEditModal()"><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                <% } %>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- LEFT COL -->
            <div class="col-left">
                <div class="card glow-card">
                    <h3><i class="fas fa-coins"></i> –§–∏–Ω–∞–Ω—Å—ã</h3>
                    <div class="stat-row"><span>–ù–∞–ª–∏—á–Ω—ã–µ:</span><span class="val gold"><%= Math.floor(profile.stars).toLocaleString() %> ‚≠ê</span></div>
                    <div class="stat-row"><span>–û—Å–∫–æ–ª–∫–∏:</span><span class="val shard"><%= Math.floor(profile.shards).toLocaleString() %> ‚ú®</span></div>
                    <div class="stat-row"><span>–í –∞–∫—Ü–∏—è—Ö:</span><span class="val"><%= (typeof portfolioValue !== 'undefined' ? portfolioValue : 0).toFixed(2) %> ‚≠ê</span></div>
                    <div class="divider"></div>
                    <div class="stat-row total"><span>Net Worth:</span><span class="val"><%= (typeof netWorth !== 'undefined' ? netWorth : 0).toFixed(2) %> ‚≠ê</span></div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-chart-bar"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                    <div class="stat-row"><span>–°–æ–æ–±—â–µ–Ω–∏–π:</span><span class="val"><%= profile.totalMessages %></span></div>
                    <div class="stat-row"><span>–ì–æ–ª–æ—Å (–≤—Å–µ–≥–æ):</span><span class="val"><%= (profile.totalVoiceTime / 3600).toFixed(1) %> —á.</span></div>
                    <div class="stat-row"><span>–ó–∞—à–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:</span><span class="val small"><%= new Date(profile.joinedAt).toLocaleDateString() %></span></div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-heart"></i> –°–µ–º—å—è</h3>
                    <% if (profile.marriedTo) { %>
                        <div class="marriage-info">
                            <div class="heart-icon"><i class="fas fa-heart"></i></div>
                            <div>
                                <p>–í –±—Ä–∞–∫–µ —Å <strong><%= typeof partnerName !== 'undefined' ? partnerName : '...' %></strong></p>
                                <p class="small-date">—Å <%= new Date(profile.marriageDate).toLocaleDateString() %></p>
                            </div>
                        </div>
                    <% } else { %>
                        <p class="text-muted">–•–æ–ª–æ—Å—Ç / –ù–µ –∑–∞–º—É–∂–µ–º</p>
                    <% } %>
                </div>
            </div>

            <!-- CENTER COL -->
            <div class="col-center">
                <div class="card graph-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ 7 –¥–Ω–µ–π</h3>
                    <div class="chart-container">
                        <div id="activityChart"></div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-briefcase"></i> –ü–æ—Ä—Ç—Ñ–µ–ª—å –∞–∫—Ü–∏–π</h3>
                    <% if (typeof portfolioDetails !== 'undefined' && portfolioDetails.length > 0) { %>
                        <table class="simple-table">
                            <thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th></tr></thead>
                            <tbody>
                                <% portfolioDetails.forEach(p => { %>
                                    <tr>
                                        <td class="ticker-cell">$<%= p.ticker %></td>
                                        <td><%= p.quantity %></td>
                                        <td><%= p.currentPrice.toFixed(1) %></td>
                                        <td><strong style="color: #ffd700;"><%= p.value.toFixed(0) %></strong></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <p class="text-muted">–ü–æ—Ä—Ç—Ñ–µ–ª—å –ø—É—Å—Ç. <a href="/market" style="color: var(--primary);">–ö—É–ø–∏—Ç—å –∞–∫—Ü–∏–∏?</a></p>
                    <% } %>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-scroll"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã</h3>
                    <% if (typeof quests !== 'undefined' && quests.length > 0) { %>
                        <div class="quest-list">
                            <% quests.forEach(q => { %>
                                <% if (!q.isCompleted) { %>
                                    <div class="quest-item">
                                        <div class="quest-header">
                                            <span class="quest-name"><%= q.details.name %></span>
                                            <span class="quest-progress"><%= q.progress %> / <%= q.target %></span>
                                        </div>
                                        <div class="progress-bar-bg">
                                            <div class="progress-bar-fill" style="width: <%= (q.progress / q.target) * 100 %>%;"></div>
                                        </div>
                                    </div>
                                <% } %>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤</p>
                    <% } %>
                </div>
            </div>

            <!-- RIGHT COL -->
            <div class="col-right">
                <div class="card">
                    <h3><i class="fas fa-box-open"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (<%= profile.inventory.length %>)</h3>
                    <!-- –°–ï–¢–ö–ê –ò–ù–í–ï–ù–¢–ê–†–Ø (–ò–°–ü–û–õ–¨–ó–£–ï–¢ ASSET MAP) -->
                    <div class="inventory-grid">
                        <% profile.inventory.slice(0, 12).forEach(item => { 
                            // –î—É–±–ª–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –∞—Å—Å–µ—Ç–æ–≤ –∑–¥–µ—Å—å, —Ç.–∫. —ç—Ç–æ —Ü–∏–∫–ª
                            const cat = item.details ? item.details.category : '';
                            let imageUrl = null;
                            let showEmoji = true;

                            if (cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' || cat === '–ö–æ—Å–º–µ—Ç–∏–∫–∞') {
                                let filename = assetMap[item.itemId];
                                if (!filename) {
                                    filename = item.itemId.replace('profile_frame_', '').replace('profile_bg_', '');
                                }
                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞–ø–∫—É
                                let folder = item.itemId.includes('frame') ? 'frames' : 'backgrounds';
                                if (item.itemId.includes('bg')) folder = 'backgrounds';
                                
                                imageUrl = `/assets/${folder}/${filename}.webp`;
                                showEmoji = false;
                            } else if (item.details && item.details.imageUrl_web) {
                                imageUrl = item.details.imageUrl_web;
                                showEmoji = false;
                            }

                            let rarity = 'common';
                            const name = (item.details ? item.details.name : '').toLowerCase();
                            if (name.includes('–ª–µ–≥–µ–Ω–¥–∞—Ä') || name.includes('–º–∏—Ñ–∏—á') || cat === '–õ—É—Ç–±–æ–∫—Å') rarity = 'legendary';
                            else if (name.includes('—Ä–µ–¥–∫–∏–π') || cat === '–£–∫—Ä–∞—à–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è') rarity = 'epic';
                            else if (name.includes('–Ω–µ–æ–±—ã—á–Ω—ã–π')) rarity = 'rare';
                        %>
                            <div class="inv-item <%= rarity %>" data-tooltip="<%= item.details ? item.details.name : item.itemId %>">
                                <div class="inv-icon">
                                    <% if (!showEmoji && imageUrl) { %>
                                        <img src="<%= imageUrl %>" alt="item" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div class="inv-emoji" style="display:none"><%= item.details ? item.details.emoji : 'üì¶' %></div>
                                    <% } else { %>
                                        <div class="inv-emoji"><%= item.details ? item.details.emoji : 'üì¶' %></div>
                                    <% } %>
                                </div> 
                                <div class="inv-name"><%= item.details ? item.details.name : item.itemId %></div>
                                <span class="inv-qty">x<%= item.quantity %></span>
                            </div>
                        <% }) %>
                    </div>
                    <% if (isOwner) { %>
                        <a href="/inventory" class="btn-secondary full-width" style="margin-top: 15px; justify-content: center;">–û—Ç–∫—Ä—ã—Ç—å –≤–µ—Å—å</a>
                    <% } %>
                </div>

               <div class="card">
                    <h3><i class="fas fa-trophy"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                    <div class="achievements-list">
                        <% if (typeof achievements !== 'undefined' && achievements.length > 0) { %>
                            <% achievements.forEach(ach => { %>
                                <div class="ach-tag" title="<%= ach.details.description %>">
                                    <%= ach.details.medalEmoji %> <%= ach.details.name %>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</p>
                        <% } %>
                    </div>
                </div>
                
                <% if (isOwner) { %>
                    <div class="card danger-zone">
                        <h3><i class="fas fa-user-secret"></i> –õ–∏—á–Ω–æ–µ</h3>
                        <p>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: <strong><%= profile.warningsReceived %></strong></p>
                        <p>–ú—å—é—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: <strong><%= profile.mutesIssued %></strong></p>
                        <% if (profile.taxDue > 0) { %>
                             <p class="tax-alert">–ù–∞–ª–æ–≥–æ–≤—ã–π –¥–æ–ª–≥: <%= profile.taxDue %> ‚≠ê</p>
                        <% } %>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <% if (isOwner) { %>
        <div class="modal-overlay" id="editModal">
            <div class="modal-box">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü—Ä–æ—Ñ–∏–ª—è</h2>
                <form action="/profile/update" method="POST">
                    <label>–û —Å–µ–±–µ</label>
                    <textarea name="bio" maxlength="150" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."><%= profile.bio %></textarea>
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn-confirm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    <% } %>

<%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts" defer></script>

    <script>
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
        document.addEventListener('DOMContentLoaded', function () {
            
            // –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü)
            <% if (isOwner) { %>
                window.openEditModal = function() { 
                    const modal = document.getElementById('editModal');
                    if (modal) modal.classList.add('active'); 
                }
                window.closeEditModal = function() { 
                    const modal = document.getElementById('editModal');
                    if (modal) modal.classList.remove('active'); 
                }
            <% } %>

            // –õ–æ–≥–∏–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
            const history = <%- typeof profile.dailyActivityHistory !== 'undefined' ? JSON.stringify(profile.dailyActivityHistory) : '[]' %>;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            if (history.length > 0 && document.querySelector("#activityChart") && typeof ApexCharts !== 'undefined') {
                const last7Days = history.slice(-7);
                const dates = last7Days.map(h => new Date(h.date).toLocaleDateString('ru-RU', {weekday: 'short'}));
                const msgData = last7Days.map(h => h.messages);
                const voiceData = last7Days.map(h => (h.voiceSeconds / 60).toFixed(0));

                const options = {
                    series: [{ name: '–°–æ–æ–±—â–µ–Ω–∏—è', data: msgData }, { name: '–í–æ–π—Å (–º–∏–Ω)', data: voiceData }],
                    chart: { type: 'area', height: 250, background: 'transparent', toolbar: { show: false }, fontFamily: 'Montserrat, sans-serif' },
                    colors: ['#5865F2', '#ffd700'],
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100] } },
                    theme: { mode: 'dark' },
                    xaxis: { categories: dates, axisBorder: { show: false }, axisTicks: { show: false }, labels: { style: { colors: '#9CA3AF' } } },
                    yaxis: { show: false },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4 },
                    legend: { position: 'top', horizontalAlign: 'right' }
                };

                const chart = new ApexCharts(document.querySelector("#activityChart"), options);
                chart.render();
            }
        });
    </script>
</body>
</html>